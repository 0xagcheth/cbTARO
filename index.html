<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <!-- Farcaster Mini App embed meta tags -->
    <meta name="fc:miniapp" content="{&quot;version&quot;:&quot;1&quot;,&quot;imageUrl&quot;:&quot;https://0xagcheth.github.io/cbTARO/Assets/imagine/b.png&quot;,&quot;button&quot;:{&quot;title&quot;:&quot;Start&quot;,&quot;action&quot;:{&quot;type&quot;:&quot;launch_frame&quot;,&quot;name&quot;:&quot;cbTARO&quot;,&quot;url&quot;:&quot;https://0xagcheth.github.io/cbTARO/&quot;,&quot;splashImageUrl&quot;:&quot;https://0xagcheth.github.io/cbTARO/Assets/imagine/cr.png&quot;,&quot;splashBackgroundColor&quot;:&quot;#0b1020&quot;}}}" />

    <!-- Open Graph tags for sharing outside Farcaster -->
    <meta property="og:title" content="cbTARO - Mystical Tarot Reading on Base" />
    <meta property="og:description" content="Get mystical tarot readings powered by AI on the Base network" />
    <meta property="og:image" content="https://0xagcheth.github.io/cbTARO/Assets/imagine/b.png" />
    <meta property="og:url" content="https://0xagcheth.github.io/cbTARO/" />
    <meta property="og:type" content="website" />

    <title>cbTARO - Mystical Tarot Reading on Base</title>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- Farcaster Mini Apps SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@0.0.32/dist/index.umd.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Mobile WebView fixes script -->
    <script>
      // Set dynamic viewport height for mobile WebView compatibility
      function setVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);

        // Enable debug mode if debug=1 is in URL
        if (window.location.search.includes('debug=1')) {
          document.documentElement.setAttribute('data-debug', '1');
          document.documentElement.setAttribute('data-viewport', `${window.innerWidth}x${window.innerHeight}`);

          console.log(`üì± Viewport: ${window.innerWidth}x${window.innerHeight}, --vh: ${vh}px`);
          console.log(`üì± Safe areas: top=${getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top')}, bottom=${getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom')}`);
          console.log('üîß DEBUG MODE ENABLED: All containers have red outlines to find layout issues');
        } else {
          document.documentElement.removeAttribute('data-debug');
          document.documentElement.removeAttribute('data-viewport');
        }
      }

      // Set initial value
      setVH();

      // Update on resize/orientation change
      window.addEventListener('resize', setVH);
      window.addEventListener('orientationchange', function() {
        // Delay to account for mobile browser UI changes
        setTimeout(setVH, 100);
      });
    </script>

    <!-- Farcaster SDK ready check script -->
    <script>
      // Global function to check and call Farcaster SDK ready
      window.checkFarcasterReady = function() {
        console.log('üîç Checking Farcaster SDK readiness...');

        // Check different possible SDK global names
        const sdk = window.farcaster || window.farcasterSDK || window.sdk || window.FarcasterSDK;

        if (sdk && sdk.actions && typeof sdk.actions.ready === 'function') {
          console.log('‚úÖ Farcaster SDK is ready, calling actions.ready()');
          try {
            sdk.actions.ready();
            console.log('‚úÖ Successfully called farcaster.actions.ready()');
            return true;
          } catch (error) {
            console.error('‚ùå Error in farcaster.actions.ready():', error);
            return false;
          }
        } else {
          console.log('‚è≥ Farcaster SDK not ready yet, will retry...');
          return false;
        }
      };

      // Try to initialize immediately
      if (document.readyState === 'complete') {
        window.checkFarcasterReady();
      } else {
        // Wait for DOM and then check
        document.addEventListener('DOMContentLoaded', function() {
          // Small delay to ensure all scripts are loaded
          setTimeout(window.checkFarcasterReady, 100);
        });

        // Also check on window load
        window.addEventListener('load', function() {
          setTimeout(window.checkFarcasterReady, 50);
        });
      }

      // Periodic check for SDK (in case it loads asynchronously)
      let sdkCheckInterval = setInterval(function() {
        if (window.checkFarcasterReady()) {
          clearInterval(sdkCheckInterval);
        }
      }, 500);

      // Clear interval after 10 seconds to avoid infinite checking
      setTimeout(function() {
        clearInterval(sdkCheckInterval);
      }, 10000);
    </script>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Safety check for ethers
      if (typeof ethers === 'undefined') {
        console.error('ethers.js not loaded');
      }

      // Tarot card data based on tarot.com meanings
      // Source: https://www.tarot.com/tarot/cards
      const ALL_CARDS = [
        // Major Arcana
        {
          id: 0,
          name: "The Fool",
          keyword: "New Beginnings",
          description: "The Fool represents new beginnings, having faith in the future, being inexperienced, not knowing what to expect, having beginner's luck, improvisation and believing in the universe. This card encourages you to take a leap of faith and embrace the unknown with an open heart.",
          imagePath: "./public/Assets/imagine/taro_cards/THE FOOL.png",
        },
        {
          id: 1,
          name: "The Magician",
          keyword: "Manifestation",
          description: "The Magician represents manifestation, resourcefulness, power, and inspired action. You have all the tools you need to make your dreams come true. This card encourages you to take action and use your skills and resources to create the life you desire.",
          imagePath: "./public/Assets/imagine/taro_cards/THE MAGICIAN.png",
        },
        {
          id: 2,
          name: "The High Priestess",
          keyword: "Intuition",
          description: "The High Priestess represents intuition, sacred knowledge, and the subconscious mind. She encourages you to look within and trust your inner voice. This card suggests that answers lie in silence, meditation, and connecting with your spiritual side.",
          imagePath: "./public/Assets/imagine/taro_cards/THE HIGH PRIESTESS.png",
        },
        {
          id: 3,
          name: "The Empress",
          keyword: "Fertility",
          description: "The Empress represents fertility, nurturing, abundance, and Mother Nature. She embodies creativity, sensuality, and the power of creation. This card encourages you to connect with nature, express your creativity, and nurture yourself and others.",
          imagePath: "./public/Assets/imagine/taro_cards/THE EMPRESS.png",
        },
        {
          id: 4,
          name: "The Emperor",
          keyword: "Authority",
          description: "The Emperor represents authority, structure, control, and fatherhood. He embodies stability, power, and the ability to create order from chaos. This card encourages you to take control, set boundaries, and build a solid foundation for your goals.",
          imagePath: "./public/Assets/imagine/taro_cards/THE EMPEROR.png",
        },
        {
          id: 5,
          name: "The Hierophant",
          keyword: "Spiritual Wisdom",
          description: "The Hierophant represents tradition, conformity, morality, and ethics. He embodies spiritual wisdom, religious beliefs, and conventional values. This card encourages you to seek guidance from mentors, follow established traditions, and find meaning in structured belief systems.",
          imagePath: "./public/Assets/imagine/taro_cards/THE HIEROPHANT.png",
        },
        {
          id: 6,
          name: "The Lovers",
          keyword: "Love",
          description: "The Lovers represent love, harmony, relationships, values alignment, and choices. This card encourages you to make decisions based on your values and what truly matters to you. It can also indicate a significant relationship or partnership in your life.",
          imagePath: "./public/Assets/imagine/taro_cards/THE LOVERS.png",
        },
        {
          id: 7,
          name: "The Chariot",
          keyword: "Control",
          description: "The Chariot represents control, willpower, success, action, and determination. You have the drive and ambition to overcome obstacles and achieve your goals. This card encourages you to stay focused and use your willpower to move forward despite challenges.",
          imagePath: "./public/Assets/imagine/taro_cards/THE CHARIOT.png",
        },
        {
          id: 8,
          name: "Strength",
          keyword: "Strength",
          description: "Strength represents strength, courage, persuasion, influence, and compassion. True strength comes from inner calm and patience, not brute force. This card encourages you to be gentle yet firm, and to use your inner power wisely.",
          imagePath: "./public/Assets/imagine/taro_cards/STRENGTH.png",
        },
        {
          id: 9,
          name: "The Hermit",
          keyword: "Soul Searching",
          description: "The Hermit represents soul searching, introspection, being alone, and inner guidance. This card encourages you to take time for reflection, seek answers within, and trust your inner wisdom. Sometimes you need to withdraw from the world to find clarity.",
          imagePath: "./public/Assets/imagine/taro_cards/THE HERMIT.png",
        },
        {
          id: 10,
          name: "Wheel of Fortune",
          keyword: "Good Luck",
          description: "The Wheel of Fortune represents good luck, karma, life cycles, and a turning point. Everything in life is cyclical, and change is constant. This card reminds you that both good and challenging times are temporary, and the wheel will continue to turn.",
          imagePath: "./public/Assets/imagine/taro_cards/WHEEL OF FORTUNE.png",
        },
        {
          id: 11,
          name: "Justice",
          keyword: "Justice",
          description: "Justice represents justice, fairness, truth, cause and effect, and law. Every action has consequences, and balance will be restored. This card encourages you to make fair decisions, take responsibility for your actions, and seek truth and integrity.",
          imagePath: "./public/Assets/imagine/taro_cards/JUSTICE.png",
        },
        {
          id: 12,
          name: "The Hanged Man",
          keyword: "Pause",
          description: "The Hanged Man represents pause, suspension, letting go, and new perspectives. Sometimes you need to stop and look at things from a different angle. This card encourages you to surrender, release control, and see things from a fresh viewpoint.",
          imagePath: "./public/Assets/imagine/taro_cards/THE HANGED MAN.png",
        },
        {
          id: 13,
          name: "Death",
          keyword: "Endings",
          description: "Death represents endings, change, transformation, and transition. This card signifies the end of a cycle and the beginning of something new. It encourages you to let go of what no longer serves you and embrace transformation and renewal.",
          imagePath: "./public/Assets/imagine/taro_cards/DEATH.png",
        },
        {
          id: 14,
          name: "Temperance",
          keyword: "Balance",
          description: "Temperance represents balance, moderation, patience, and purpose. This card encourages you to find the middle path, blend opposites, and maintain equilibrium in all areas of your life. Patience and moderation will lead to harmony.",
          imagePath: "./public/Assets/imagine/taro_cards/TEMPERANCE.png",
        },
        {
          id: 15,
          name: "The Devil",
          keyword: "Shadow Self",
          description: "The Devil represents addiction, materialism, playfulness, and bondage. This card reveals what holds you captive‚Äîwhether it's unhealthy attachments, limiting beliefs, or negative patterns. It encourages you to recognize your chains and break free.",
          imagePath: "./public/Assets/imagine/taro_cards/THE DEVIL.png",
        },
        {
          id: 16,
          name: "The Tower",
          keyword: "Sudden Change",
          description: "The Tower represents sudden change, upheaval, chaos, revelation, and awakening. This card signifies a dramatic shift that breaks down old structures to make way for new ones. While disruptive, this change is necessary for growth and liberation.",
          imagePath: "./public/Assets/imagine/taro_cards/THE TOWER.png",
        },
        {
          id: 17,
          name: "The Star",
          keyword: "Hope",
          description: "The Star represents hope, faith, purpose, renewal, and spirituality. After the darkness of the Tower, the Star brings light and healing. This card encourages you to have faith in the future, find inspiration, and reconnect with your spiritual purpose.",
          imagePath: "./public/Assets/imagine/taro_cards/THE STAR.png",
        },
        {
          id: 18,
          name: "The Moon",
          keyword: "Illusion",
          description: "The Moon represents illusion, fear, anxiety, subconscious, and intuition. This card reveals hidden fears and anxieties that may be clouding your judgment. It encourages you to trust your intuition while being aware of deception and illusion.",
          imagePath: "./public/Assets/imagine/taro_cards/THE MOON.png",
        },
        {
          id: 19,
          name: "The Sun",
          keyword: "Positivity",
          description: "The Sun represents positivity, fun, warmth, success, and vitality. This card brings joy, happiness, and success. It encourages you to embrace life with enthusiasm, celebrate your achievements, and bask in the warmth of positive energy.",
          imagePath: "./public/Assets/imagine/taro_cards/THE SUN.png",
        },
        {
          id: 20,
          name: "Judgement",
          keyword: "Judgement",
          description: "Judgement represents judgement, rebirth, inner calling, and absolution. This card signifies a time of reflection, evaluation, and awakening to your life's purpose. It encourages you to answer your inner calling and make peace with your past.",
          imagePath: "./public/Assets/imagine/taro_cards/JUDGEMENT.png",
        },
        {
          id: 21,
          name: "The World",
          keyword: "Completion",
          description: "The World represents completion, accomplishment, travel, and achievement. This card signifies the successful completion of a journey or cycle. It encourages you to celebrate your achievements, embrace new opportunities, and recognize the wholeness of your experience.",
          imagePath: "./public/Assets/imagine/taro_cards/THE WORLD.png",
        },
        // Wands (Minor Arcana)
        {
          id: 22,
          name: "Ace of Wands",
          keyword: "Inspiration",
          description: "The Ace of Wands represents inspiration, spiritual enlightenment, new opportunities, and new projects. This card brings a burst of creative energy and enthusiasm. It encourages you to pursue your passions and start new ventures with confidence.",
          imagePath: "./public/Assets/imagine/taro_cards/ACE OF WANDS.png",
        },
        {
          id: 23,
          name: "Two of Wands",
          keyword: "Planning",
          description: "The Two of Wands represents planning, progress, discovery, and making decisions. This card signifies the beginning of a journey and the courage to step into the unknown. It encourages you to make bold choices and trust in your ability to create your own path.",
          imagePath: "./public/Assets/imagine/taro_cards/TWO OF WANDS.png",
        },
        {
          id: 24,
          name: "Three of Wands",
          keyword: "Expansion",
          description: "The Three of Wands represents expansion, foresight, overseas opportunities, and looking ahead. This card signifies growth, progress, and the rewards of your efforts. It encourages you to look to the future with optimism and expand your horizons.",
          imagePath: "./public/Assets/imagine/taro_cards/THREE OF WANDS.png",
        },
        {
          id: 25,
          name: "Four of Wands",
          keyword: "Celebration",
          description: "The Four of Wands represents celebration, joy, harmony, and homecoming. This card signifies a time of happiness, stability, and community. It encourages you to celebrate your achievements and enjoy the harmonious relationships in your life.",
          imagePath: "./public/Assets/imagine/taro_cards/FOUR OF WANDS.png",
        },
        {
          id: 26,
          name: "Five of Wands",
          keyword: "Conflict",
          description: "The Five of Wands represents conflict, disagreements, competition, and tension. This card signifies challenges and obstacles that require effort to overcome. It encourages you to embrace healthy competition and use conflicts as opportunities for growth.",
          imagePath: "./public/Assets/imagine/taro_cards/FIVE OF WANDS.png",
        },
        {
          id: 27,
          name: "Six of Wands",
          keyword: "Success",
          description: "The Six of Wands represents success, public recognition, progress, and self-confidence. This card signifies achievement, victory, and the recognition of your efforts. It encourages you to celebrate your successes and share your accomplishments with others.",
          imagePath: "./public/Assets/imagine/taro_cards/SIX OF WANDS.png",
        },
        {
          id: 28,
          name: "Seven of Wands",
          keyword: "Challenge",
          description: "The Seven of Wands represents challenge, competition, perseverance, and defense. This card signifies standing your ground and defending what you've achieved. It encourages you to be courageous, maintain your position, and overcome obstacles with determination.",
          imagePath: "./public/Assets/imagine/taro_cards/SEVEN OF WANDS.png",
        },
        {
          id: 29,
          name: "Eight of Wands",
          keyword: "Speed",
          description: "The Eight of Wands represents speed, action, alignment, and air travel. This card signifies rapid progress, momentum, and things moving quickly. It encourages you to take swift action and trust that everything is aligning for your highest good.",
          imagePath: "./public/Assets/imagine/taro_cards/EIGHT OF WANDS.png",
        },
        {
          id: 30,
          name: "Nine of Wands",
          keyword: "Resilience",
          description: "The Nine of Wands represents resilience, courage, persistence, and grit. This card signifies inner strength and the ability to keep going despite challenges. It encourages you to draw on your inner reserves and maintain your determination.",
          imagePath: "./public/Assets/imagine/taro_cards/NINE OF WANDS.png",
        },
        {
          id: 31,
          name: "Ten of Wands",
          keyword: "Burden",
          description: "The Ten of Wands represents burden, extra responsibility, hard work, and doing it all. This card signifies feeling overwhelmed by responsibilities and the need to delegate. It encourages you to lighten your load and focus on what truly matters.",
          imagePath: "./public/Assets/imagine/taro_cards/TEN OF WANDS.png",
        },
        {
          id: 32,
          name: "Page of Wands",
          keyword: "Inspiration",
          description: "The Page of Wands represents inspiration, ideas, discovery, and limitless potential. This card signifies enthusiasm, curiosity, and the spark of new ideas. It encourages you to explore your creative potential and embrace new adventures.",
          imagePath: "./public/Assets/imagine/taro_cards/PAGE OF WANDS.png",
        },
        {
          id: 33,
          name: "Knight of Wands",
          keyword: "Adventure",
          description: "The Knight of Wands represents adventure, passion, impulsiveness, and enthusiasm. This card signifies energy, action, and the pursuit of goals with passion. It encourages you to embrace change, take risks, and follow your passions with courage.",
          imagePath: "./public/Assets/imagine/taro_cards/KNIGHT OF WANDS.png",
        },
        {
          id: 34,
          name: "Queen of Wands",
          keyword: "Courage",
          description: "The Queen of Wands represents courage, determination, joy, and radiance. This card embodies confidence, charisma, and creative fire. It encourages you to express yourself boldly, pursue your passions, and shine your light brightly in the world.",
          imagePath: "./public/Assets/imagine/taro_cards/QUEEN OF WANDS.png",
        },
        {
          id: 35,
          name: "King of Wands",
          keyword: "Leadership",
          description: "The King of Wands represents leadership, vision, entrepreneurship, and honor. This card signifies natural-born leadership and the ability to inspire others. It encourages you to step into your power, lead with integrity, and pursue your vision with confidence.",
          imagePath: "./public/Assets/imagine/taro_cards/KING OF WANDS.png",
        },
        // Cups (Minor Arcana)
        {
          id: 36,
          name: "Ace of Cups",
          keyword: "Love",
          description: "The Ace of Cups represents love, new relationships, compassion, and creativity. This card signifies emotional fulfillment, new beginnings in love, and the opening of the heart. It encourages you to embrace love, compassion, and emotional healing.",
          imagePath: "./public/Assets/imagine/taro_cards/ACE OF CUPS.png",
        },
        {
          id: 37,
          name: "Two of Cups",
          keyword: "Unified Love",
          description: "The Two of Cups represents unified love, partnership, mutual attraction, and relationships. This card signifies a deep connection, partnership, or romantic relationship. It encourages you to open your heart and form meaningful connections with others.",
          imagePath: "./public/Assets/imagine/taro_cards/TWO OF CUPS.png",
        },
        {
          id: 38,
          name: "Three of Cups",
          keyword: "Celebration",
          description: "The Three of Cups represents celebration, friendship, creativity, and community. This card signifies joy, abundance, and the celebration of life with others. It encourages you to nurture your relationships and celebrate the connections that bring you happiness.",
          imagePath: "./public/Assets/imagine/taro_cards/THREE OF CUPS.png",
        },
        {
          id: 39,
          name: "Four of Cups",
          keyword: "Meditation",
          description: "The Four of Cups represents meditation, contemplation, apathy, and reevaluation. This card signifies feeling disconnected or disillusioned, but also the opportunity for introspection. It encourages you to look within and find new sources of fulfillment.",
          imagePath: "./public/Assets/imagine/taro_cards/FOUR OF CUPS.png",
        },
        {
          id: 40,
          name: "Five of Cups",
          keyword: "Regret",
          description: "The Five of Cups represents regret, failure, disappointment, and pessimism. This card acknowledges loss and grief, but reminds you that not all is lost. It encourages you to focus on what remains and find hope in the midst of sorrow.",
          imagePath: "./public/Assets/imagine/taro_cards/FIVE OF CUPS.png",
        },
        {
          id: 41,
          name: "Six of Cups",
          keyword: "Revisiting",
          description: "The Six of Cups represents revisiting the past, childhood memories, innocence, and joy. This card signifies nostalgia, simplicity, and the pleasure of simple things. It encourages you to reconnect with your inner child and find joy in life's simple pleasures.",
          imagePath: "./public/Assets/imagine/taro_cards/SIX OF CUPS.png",
        },
        {
          id: 42,
          name: "Seven of Cups",
          keyword: "Opportunity",
          description: "The Seven of Cups represents opportunity, choice, wishful thinking, and illusion. This card signifies having many options and possibilities, but also confusion about which path to choose. It encourages you to discern between fantasy and reality.",
          imagePath: "./public/Assets/imagine/taro_cards/SEVEN OF CUPS.png",
        },
        {
          id: 43,
          name: "Eight of Cups",
          keyword: "Disappointment",
          description: "The Eight of Cups represents disappointment, abandonment, withdrawal, and escapism. This card signifies leaving behind what no longer serves you and searching for deeper meaning. It encourages you to let go of unfulfilling situations and seek emotional fulfillment.",
          imagePath: "./public/Assets/imagine/taro_cards/EIGHT OF CUPS.png",
        },
        {
          id: 44,
          name: "Nine of Cups",
          keyword: "Contentment",
          description: "The Nine of Cups represents contentment, satisfaction, gratitude, and wish fulfillment. This card signifies emotional satisfaction, happiness, and the achievement of your desires. It encourages you to appreciate what you have and share your abundance with others.",
          imagePath: "./public/Assets/imagine/taro_cards/NINE OF CUPS.png",
        },
        {
          id: 45,
          name: "Ten of Cups",
          keyword: "Divine Love",
          description: "The Ten of Cups represents divine love, blissful relationships, harmony, and alignment. This card signifies happiness, emotional fulfillment, and harmonious relationships. It encourages you to appreciate the love and joy in your life and celebrate your connections.",
          imagePath: "./public/Assets/imagine/taro_cards/TEN OF CUPS.png",
        },
        {
          id: 46,
          name: "Page of Cups",
          keyword: "Creative Opportunities",
          description: "The Page of Cups represents creative opportunities, intuitive messages, curiosity, and possibility. This card signifies new emotional experiences and intuitive insights. It encourages you to be open to new possibilities and trust your intuition.",
          imagePath: "./public/Assets/imagine/taro_cards/PAGE OF CUPS.png",
        },
        {
          id: 47,
          name: "Knight of Cups",
          keyword: "Creativity",
          description: "The Knight of Cups represents creativity, romance, bringing or receiving a message, and imagination. This card signifies emotional expression, artistic pursuits, and romantic gestures. It encourages you to follow your heart and express your emotions creatively.",
          imagePath: "./public/Assets/imagine/taro_cards/KNIGHT OF CUPS.png",
        },
        {
          id: 48,
          name: "Queen of Cups",
          keyword: "Compassionate",
          description: "The Queen of Cups represents compassionate, caring, emotionally stable, and intuitive. This card signifies emotional intelligence, empathy, and nurturing qualities. It encourages you to trust your intuition and care for yourself and others with compassion.",
          imagePath: "./public/Assets/imagine/taro_cards/QUEEN OF CUPS.png",
        },
        {
          id: 49,
          name: "King of Cups",
          keyword: "Emotionally Balanced",
          description: "The King of Cups represents emotionally balanced, compassionate, diplomatic, and wise. This card signifies emotional maturity, compassion, and the ability to handle emotions wisely. It encourages you to lead with empathy and maintain emotional balance.",
          imagePath: "./public/Assets/imagine/taro_cards/KING OF CUPS.png",
        },
        // Swords (Minor Arcana)
        {
          id: 50,
          name: "Ace of Swords",
          keyword: "Breakthroughs",
          description: "The Ace of Swords represents breakthroughs, new ideas, mental clarity, and success. This card signifies mental clarity, sharp thinking, and the power of truth. It encourages you to speak your truth and use your intellect to overcome challenges.",
          imagePath: "./public/Assets/imagine/taro_cards/ACE OF SWORDS.png",
        },
        {
          id: 51,
          name: "Two of Swords",
          keyword: "Difficult Decisions",
          description: "The Two of Swords represents difficult decisions, weighing up options, and inner conflict. This card signifies being at a crossroads and needing to make a choice. It encourages you to seek clarity and trust your inner wisdom when making decisions.",
          imagePath: "./public/Assets/imagine/taro_cards/TWO OF SWORDS.png",
        },
        {
          id: 52,
          name: "Three of Swords",
          keyword: "Heartbreak",
          description: "The Three of Swords represents heartbreak, emotional pain, sorrow, grief, and hurt. This card acknowledges difficult emotions and painful experiences. It encourages you to process your feelings, seek support, and allow yourself to heal.",
          imagePath: "./public/Assets/imagine/taro_cards/THREE OF SWARDS.png",
        },
        {
          id: 53,
          name: "Four of Swords",
          keyword: "Rest",
          description: "The Four of Swords represents rest, relaxation, meditation, and contemplation. This card signifies the need for a break and time to recharge. It encourages you to take time for self-care and allow yourself to rest and recover.",
          imagePath: "./public/Assets/imagine/taro_cards/FOUR OF SWORDS.png",
        },
        {
          id: 54,
          name: "Five of Swords",
          keyword: "Conflict",
          description: "The Five of Swords represents conflict, disagreements, competition, and defeat. This card signifies arguments, tension, and the need to choose your battles wisely. It encourages you to consider the cost of winning and seek peaceful resolutions.",
          imagePath: "./public/Assets/imagine/taro_cards/FIVE OF SWARDS.png",
        },
        {
          id: 55,
          name: "Six of Swords",
          keyword: "Transition",
          description: "The Six of Swords represents transition, change, rite of passage, and releasing baggage. This card signifies moving from difficult times to calmer waters. It encourages you to let go of what no longer serves you and embrace positive change.",
          imagePath: "./public/Assets/imagine/taro_cards/SIX OF SWORDS.png",
        },
        {
          id: 56,
          name: "Seven of Swords",
          keyword: "Betrayal",
          description: "The Seven of Swords represents betrayal, deception, getting away with something, and stealth. This card signifies dishonesty, manipulation, or avoiding responsibility. It encourages you to be honest with yourself and others, and to face reality.",
          imagePath: "./public/Assets/imagine/taro_cards/SEVEN OF SWORDS.png",
        },
        {
          id: 57,
          name: "Eight of Swords",
          keyword: "Negative Thoughts",
          description: "The Eight of Swords represents negative thoughts, self-imposed restriction, and inner critic. This card signifies feeling trapped by your own thoughts and limiting beliefs. It encourages you to break free from mental restrictions and see new possibilities.",
          imagePath: "./public/Assets/imagine/taro_cards/EIGHT OF SWORDS.png",
        },
        {
          id: 58,
          name: "Nine of Swords",
          keyword: "Anxiety",
          description: "The Nine of Swords represents anxiety, worry, fear, depression, and nightmares. This card signifies mental anguish and the torment of negative thoughts. It encourages you to face your fears and seek help to find peace of mind.",
          imagePath: "./public/Assets/imagine/taro_cards/NINE OF SWORDS.png",
        },
        {
          id: 59,
          name: "Ten of Swords",
          keyword: "Painful Endings",
          description: "The Ten of Swords represents painful endings, deep wounds, betrayal, and loss. This card signifies rock bottom and the need for transformation. It encourages you to accept that some chapters must end so new beginnings can emerge.",
          imagePath: "./public/Assets/imagine/taro_cards/TEN OF SWORDS.png",
        },
        {
          id: 60,
          name: "Page of Swords",
          keyword: "New Ideas",
          description: "The Page of Swords represents new ideas, curiosity, thirst for knowledge, and new ways of communicating. This card signifies mental agility and the excitement of learning. It encourages you to be curious, ask questions, and communicate clearly.",
          imagePath: "./public/Assets/imagine/taro_cards/PAGE OF SWORDS.png",
        },
        {
          id: 61,
          name: "Knight of Swords",
          keyword: "Action",
          description: "The Knight of Swords represents action, impulsiveness, defending beliefs, and fighting for what you believe in. This card encourages you to take decisive action, speak your truth, and move forward with determination, though it warns against being too hasty.",
          imagePath: "./public/Assets/imagine/taro_cards/KNIGHT OF SWORDS.png",
        },
        {
          id: 62,
          name: "Queen of Swords",
          keyword: "Independence",
          description: "The Queen of Swords represents independence, unbiased judgement, clear boundaries, and direct communication. This card signifies mental clarity, honesty, and the ability to see through deception. It encourages you to communicate with clarity and set healthy boundaries.",
          imagePath: "./public/Assets/imagine/taro_cards/QUEEN OF SWORDS.png",
        },
        {
          id: 63,
          name: "King of Swords",
          keyword: "Mental Clarity",
          description: "The King of Swords represents mental clarity, intellectual power, authority, and truth. This card signifies logical thinking, fairness, and the ability to make sound judgments. It encourages you to think clearly and communicate with authority and integrity.",
          imagePath: "./public/Assets/imagine/taro_cards/KING OF SWORDS.png",
        },
        // Pentacles (Minor Arcana)
        {
          id: 64,
          name: "Ace of Pentacles",
          keyword: "Manifestation",
          description: "The Ace of Pentacles represents manifestation, new financial opportunity, and abundance. This card signifies material success, financial stability, and the potential for wealth. It encourages you to take practical steps toward your financial goals and trust in your ability to create abundance.",
          imagePath: "./public/Assets/imagine/taro_cards/ACE OF PENTACLES.png",
        },
        {
          id: 65,
          name: "Two of Pentacles",
          keyword: "Balance",
          description: "The Two of Pentacles represents balance, priorities, and multitasking. This card signifies juggling multiple responsibilities and finding equilibrium. It encourages you to manage your time and resources effectively and maintain balance in all areas of life.",
          imagePath: "./public/Assets/imagine/taro_cards/TWO OF PENTACLES.png",
        },
        {
          id: 66,
          name: "Three of Pentacles",
          keyword: "Collaboration",
          description: "The Three of Pentacles represents collaboration, learning, and implementation. This card signifies teamwork, craftsmanship, and the rewards of hard work. It encourages you to collaborate with others and take pride in your skills and contributions.",
          imagePath: "./public/Assets/imagine/taro_cards/THREE OF PENTACLES.png",
        },
        {
          id: 67,
          name: "Four of Pentacles",
          keyword: "Control",
          description: "The Four of Pentacles represents control, stability, security, and possession. This card suggests holding tightly to what you have, but warns against being too controlling or materialistic. It encourages you to find balance between security and generosity.",
          imagePath: "./public/Assets/imagine/taro_cards/FOUR OF PENTACLES.png",
        },
        {
          id: 68,
          name: "Five of Pentacles",
          keyword: "Financial Loss",
          description: "The Five of Pentacles represents financial loss, poverty, lack mindset, and isolation. This card signifies hardship and the feeling of being left out in the cold. It encourages you to seek help, change your perspective, and remember that difficult times are temporary.",
          imagePath: "./public/Assets/imagine/taro_cards/FIVE OF PENTACLES.png",
        },
        {
          id: 69,
          name: "Six of Pentacles",
          keyword: "Giving",
          description: "The Six of Pentacles represents giving, receiving, sharing wealth, and generosity. This card signifies charity, fairness, and the balance between giving and receiving. It encourages you to be generous and recognize the abundance in your life.",
          imagePath: "./public/Assets/imagine/taro_cards/SIX OF PENTACLES.png",
        },
        {
          id: 70,
          name: "Seven of Pentacles",
          keyword: "Perseverance",
          description: "The Seven of Pentacles represents perseverance, investment, effort, and reward. This card signifies patience and the need to wait for results. It encourages you to continue working toward your goals and trust that your efforts will be rewarded in time.",
          imagePath: "./public/Assets/imagine/taro_cards/SEVEN OF PENTACLES.png",
        },
        {
          id: 71,
          name: "Eight of Pentacles",
          keyword: "Apprenticeship",
          description: "The Eight of Pentacles represents apprenticeship, repetitive tasks, mastery, and skill development. This card signifies dedication to your craft and the process of learning. It encourages you to focus on mastering your skills and take pride in your work.",
          imagePath: "./public/Assets/imagine/taro_cards/EIGHT OF PENTACLES.png",
        },
        {
          id: 72,
          name: "Nine of Pentacles",
          keyword: "Abundance",
          description: "The Nine of Pentacles represents abundance, luxury, self-sufficiency, and financial independence. This card signifies material comfort, refinement, and the rewards of hard work. It encourages you to enjoy the fruits of your labor and appreciate your achievements.",
          imagePath: "./public/Assets/imagine/taro_cards/NINE OF PENTACLES.png",
        },
        {
          id: 73,
          name: "Ten of Pentacles",
          keyword: "Wealth",
          description: "The Ten of Pentacles represents wealth, financial security, family, and long-term success. This card signifies abundance, legacy, and the completion of material goals. It encourages you to build a secure foundation for yourself and your loved ones.",
          imagePath: "./public/Assets/imagine/taro_cards/TEN OF PENTACLES.png",
        },
        {
          id: 74,
          name: "Page of Pentacles",
          keyword: "Financial Opportunity",
          description: "The Page of Pentacles represents financial opportunity, skill development, and new ideas. This card signifies practical learning and the beginning of new ventures. It encourages you to be diligent, learn new skills, and approach opportunities with enthusiasm.",
          imagePath: "./public/Assets/imagine/taro_cards/PAGE OF PENTACLES.png",
        },
        {
          id: 75,
          name: "Knight of Pentacles",
          keyword: "Hard Work",
          description: "The Knight of Pentacles represents hard work, productivity, and routine. This card signifies diligence, responsibility, and the rewards of consistent effort. It encourages you to be patient, methodical, and committed to your goals.",
          imagePath: "./public/Assets/imagine/taro_cards/KNIGHT OF PENTACLES.png",
        },
        {
          id: 76,
          name: "Queen of Pentacles",
          keyword: "Nurturing",
          description: "The Queen of Pentacles represents nurturing, practical, providing financially, and a healthy home. This card signifies abundance, generosity, and caring for others. It encourages you to create a nurturing environment and share your resources with those you love.",
          imagePath: "./public/Assets/imagine/taro_cards/QUEEN OF PENTACLES.png",
        },
        {
          id: 77,
          name: "King of Pentacles",
          keyword: "Abundance",
          description: "The King of Pentacles represents abundance, prosperity, security, and financial security. This card signifies material success, stability, and practical wisdom. It encourages you to build wealth, create security, and use your resources wisely.",
          imagePath: "./public/Assets/imagine/taro_cards/KING OF PENTACLES.png",
        },
      ];

      function getRandomCards(count) {
        const shuffled = [...ALL_CARDS].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, count);
      }

      // Helper function to resolve Farcaster profile by wallet address
      const resolveFarcasterProfileByAddress = async (address) => {
        if (!address) return null;
        
        const DEV = window.location.search.includes('debug=1');
        const NEYNAR_API_KEY = window.VITE_NEYNAR_API_KEY || 'NEYNAR_API_DOCS';
        
        try {
          if (DEV) console.log('üîç Resolving Farcaster profile for address:', address);
          
          const response = await fetch(
            `https://api.neynar.com/v2/farcaster/user/bulk-by-address?addresses=${address}`,
            {
              headers: {
                'api_key': NEYNAR_API_KEY
              }
            }
          );

          if (!response.ok) {
            if (DEV) console.warn('‚ö†Ô∏è Neynar API error:', response.status);
            return null;
          }

          const data = await response.json();
          const user = data[address]?.[0];
          
          if (!user) {
            if (DEV) console.log('üì± No Farcaster user found for address');
            return null;
          }

          const profile = {
            fid: user.fid || null,
            username: user.username || null,
            displayName: user.display_name || user.displayName || null,
            pfpUrl: user.pfp_url || user.pfp?.url || user.pfpUrl || null
          };

          if (DEV) console.log('‚úÖ Farcaster profile resolved:', profile);
          return profile;
        } catch (error) {
          if (DEV) console.warn('‚ö†Ô∏è Error resolving Farcaster profile:', error);
          return null;
        }
      };

      // Hook for unified identity management
      const useAuthIdentity = () => {
        const DEV = window.location.search.includes('debug=1');
        
        const [authState, setAuthState] = useState('loading'); // loading, miniapp_authed, wallet_disconnected, wallet_connected_fetching_profile, wallet_connected_profile_ready, error
        const [profile, setProfile] = useState(null); // {fid, username, displayName, pfpUrl}
        const [walletAddress, setWalletAddress] = useState(null);
        const [isMiniApp, setIsMiniApp] = useState(false);

        // Detect environment and load Mini App context
        useEffect(() => {
          const initAuth = async () => {
            try {
              // Check for Farcaster Mini App SDK
              const sdk = window.farcaster || window.farcasterSDK || window.sdk || window.FarcasterSDK;
              
              if (!sdk) {
                if (DEV) console.log('üì± No Farcaster SDK - browser mode');
                setIsMiniApp(false);
                setAuthState('wallet_disconnected');
                return;
              }

              // Try to get context
              let ctx = null;
              try {
                if (sdk.context) {
                  ctx = sdk.context;
                  if (ctx && typeof ctx.then === 'function') {
                    ctx = await ctx;
                  }
                } else if (typeof sdk.getContext === 'function') {
                  ctx = await sdk.getContext();
                } else if (sdk.user) {
                  ctx = { user: sdk.user };
                }
              } catch (ctxError) {
                if (DEV) console.warn('‚ö†Ô∏è Context access error:', ctxError);
              }

              if (ctx) {
                const user = ctx.user || ctx.viewer || ctx;
                if (user?.fid) {
                  const normalized = {
                    fid: user.fid || user.userFid || null,
                    username: user.username || null,
                    displayName: user.displayName || user.display_name || null,
                    pfpUrl: user.pfpUrl || user.pfp_url || user.avatarUrl || user.avatar_url || null
                  };
                  
                  if (normalized.fid) {
                    if (DEV) console.log('‚úÖ Mini App context loaded:', normalized);
                    setProfile(normalized);
                    setIsMiniApp(true);
                    setAuthState('miniapp_authed');
                    return;
                  }
                }
              }

              // Not a Mini App or no context
              setIsMiniApp(false);
              setAuthState('wallet_disconnected');
            } catch (error) {
              if (DEV) console.warn('‚ö†Ô∏è Auth init error:', error);
              setAuthState('error');
            }
          };

          initAuth();
        }, []);

        // Auto-check wallet connection in browser mode
        useEffect(() => {
          if (isMiniApp || authState === 'miniapp_authed') return;

          const checkWallet = async () => {
            if (!window.ethereum) {
              setAuthState('wallet_disconnected');
              return;
            }

            try {
              const accounts = await window.ethereum.request({ method: 'eth_accounts' });
              if (accounts && accounts.length > 0) {
                const address = accounts[0];
                setWalletAddress(address);
                setAuthState('wallet_connected_fetching_profile');
                
                // Try to resolve profile
                const resolvedProfile = await resolveFarcasterProfileByAddress(address);
                if (resolvedProfile?.fid) {
                  setProfile(resolvedProfile);
                  setAuthState('wallet_connected_profile_ready');
                } else {
                  setAuthState('wallet_connected_profile_ready'); // Connected but no Farcaster profile
                }
              } else {
                setAuthState('wallet_disconnected');
              }
            } catch (error) {
              if (DEV) console.warn('‚ö†Ô∏è Wallet check error:', error);
              setAuthState('wallet_disconnected');
            }
          };

          checkWallet();
        }, [isMiniApp, authState]);

        const connectWallet = async () => {
          if (!window.ethereum) {
            alert('MetaMask or compatible wallet not found!');
            setAuthState('error');
            return null;
          }

          try {
            setAuthState('wallet_connected_fetching_profile');
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            
            if (!accounts || accounts.length === 0) {
              setAuthState('wallet_disconnected');
              return null;
            }

            const address = accounts[0];
            setWalletAddress(address);
            
            // Resolve profile
            const resolvedProfile = await resolveFarcasterProfileByAddress(address);
            if (resolvedProfile?.fid) {
              setProfile(resolvedProfile);
              setAuthState('wallet_connected_profile_ready');
            } else {
              setAuthState('wallet_connected_profile_ready'); // Connected but no profile
            }

            return { address };
          } catch (error) {
            if (DEV) console.warn('‚ö†Ô∏è Wallet connection error:', error);
            setAuthState('wallet_disconnected');
            return null;
          }
        };

        return {
          authState,
          profile,
          walletAddress,
          isMiniApp,
          connectWallet
        };
      };

      // Unified Identity Button Component
      const UnifiedIdentityButton = ({ playButtonSound }) => {
        const DEV = window.location.search.includes('debug=1');
        const { authState, profile, walletAddress, isMiniApp, connectWallet } = useAuthIdentity();
        const [showProfileModal, setShowProfileModal] = useState(false);

        const handleClick = async (e) => {
          e.stopPropagation();
          
          if (authState === 'miniapp_authed' || authState === 'wallet_connected_profile_ready') {
            // Open profile modal
            if (playButtonSound) playButtonSound();
            setShowProfileModal(true);
          } else if (authState === 'wallet_disconnected' || authState === 'error') {
            // Connect wallet
            if (playButtonSound) playButtonSound();
            await connectWallet();
          }
        };

        const renderButtonContent = () => {
          switch (authState) {
            case 'loading':
              return <span className="spinner">‚è≥</span>;
            
            case 'miniapp_authed':
            case 'wallet_connected_profile_ready':
              if (profile?.pfpUrl) {
                return (
                  <img
                    src={profile.pfpUrl}
                    alt="Avatar"
                    className="wallet-avatar"
                    onError={(e) => {
                      e.target.style.display = 'none';
                      e.target.nextSibling.style.display = 'inline';
                    }}
                  />
                );
              }
              return profile?.fid ? "üë§" : "üîÆ";
            
            case 'wallet_connected_fetching_profile':
              return <span className="spinner">‚è≥</span>;
            
            case 'wallet_disconnected':
            case 'error':
            default:
              return "üîÆ";
          }
        };

        const getTitle = () => {
          if (authState === 'miniapp_authed' && profile) {
            return profile.displayName || profile.username || `FID: ${profile.fid}`;
          }
          if (authState === 'wallet_connected_profile_ready' && walletAddress) {
            return profile ? 
              (profile.displayName || profile.username || `FID: ${profile.fid}`) :
              `Connected: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
          }
          return "Connect Wallet (Click to connect)";
        };

        return (
          <>
            <button
              className="wallet-connect-btn"
              onClick={handleClick}
              title={getTitle()}
              disabled={authState === 'loading' || authState === 'wallet_connected_fetching_profile'}
            >
              {renderButtonContent()}
              {!profile?.pfpUrl && (profile?.fid || walletAddress) && (
                <span style={{ display: 'none' }}>üë§</span>
              )}
            </button>

            {/* Profile Modal */}
            {showProfileModal && (
              <div className="tarot-reading-overlay" onClick={() => setShowProfileModal(false)} style={{ zIndex: 2100 }}>
                <div className="tarot-reading-panel" onClick={(e) => e.stopPropagation()}>
                  <h2>Profile</h2>
                  {profile?.pfpUrl && (
                    <div className="tarot-reading-card-image">
                      <img src={profile.pfpUrl} alt="Avatar" />
                    </div>
                  )}
                  {profile?.displayName && (
                    <p className="tarot-reading-keyword">Name: {profile.displayName}</p>
                  )}
                  {profile?.username && (
                    <p className="tarot-reading-keyword">Handle: @{profile.username}</p>
                  )}
                  {profile?.fid && (
                    <p className="tarot-reading-keyword">FID: {profile.fid}</p>
                  )}
                  {walletAddress && (
                    <p className="tarot-reading-keyword">Wallet: {walletAddress.slice(0, 6)}...{walletAddress.slice(-4)}</p>
                  )}
                  {isMiniApp && (
                    <p className="tarot-reading-text" style={{ fontSize: '0.9em', opacity: 0.8 }}>
                      Connected via Farcaster Mini App
                    </p>
                  )}
                  <button 
                    className="tarot-button" 
                    onClick={() => setShowProfileModal(false)}
                    style={{ marginTop: '1rem' }}
                  >
                    Close
                  </button>
                </div>
              </div>
            )}
          </>
        );
      };

      function TarotApp() {
        const [gameStage, setGameStage] = useState("idle");
        const [selectedSpread, setSelectedSpread] = useState(null);
        const [cards, setCards] = useState([]);
        const [revealedIds, setRevealedIds] = useState([]);
        const [activeCard, setActiveCard] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [txHash, setTxHash] = useState(null);
        const [userQuestion, setUserQuestion] = useState("");
        const [aiInterpretation, setAiInterpretation] = useState(null);
        const [isGeneratingAI, setIsGeneratingAI] = useState(false);
        const [showGallery, setShowGallery] = useState(false);
        const [previousGameStage, setPreviousGameStage] = useState("idle");
        const [readingSource, setReadingSource] = useState(null); // 'gallery' | 'spread' | 'ai' | null
        const [soundEnabled, setSoundEnabled] = useState(true);

        // Wallet and payment states (kept for backward compatibility with payment logic)
        const [isWalletConnected, setIsWalletConnected] = useState(false);
        const [walletAddress, setWalletAddress] = useState(null);
        const [userFid, setUserFid] = useState(null);
        const [userAvatar, setUserAvatar] = useState(null);
        const [txStatus, setTxStatus] = useState("idle"); // idle, paying, success, error

        // Farcaster Mini App context states (kept for backward compatibility)
        const [fcUser, setFcUser] = useState(null); // {fid, username, displayName, pfpUrl}
        const [fcReady, setFcReady] = useState(false);

        // Use unified auth identity hook
        const authIdentity = useAuthIdentity();

        // Sync auth identity data with legacy states for backward compatibility
        useEffect(() => {
          if (authIdentity.profile) {
            if (authIdentity.profile.fid && !userFid) {
              setUserFid(authIdentity.profile.fid);
            }
            if (authIdentity.profile.pfpUrl && !userAvatar) {
              setUserAvatar(authIdentity.profile.pfpUrl);
            }
            if (!fcUser) {
              setFcUser(authIdentity.profile);
            }
          }
          if (authIdentity.walletAddress) {
            setWalletAddress(authIdentity.walletAddress);
            setIsWalletConnected(true);
          }
        }, [authIdentity.profile, authIdentity.walletAddress]);

        // Farcaster Mini App SDK initialization (backup check)
        useEffect(() => {
          console.log('üéØ React component mounted, checking Farcaster SDK...');

          // Small delay to ensure global script has run
          const timer = setTimeout(() => {
            if (!window.checkFarcasterReady || !window.checkFarcasterReady()) {
              // Fallback if global script failed
              console.log('üîÑ Fallback SDK check from React component');

              const sdk = window.farcaster || window.farcasterSDK || window.sdk || window.FarcasterSDK;
              if (sdk && sdk.actions && typeof sdk.actions.ready === 'function') {
                try {
                  sdk.actions.ready();
                  console.log('‚úÖ Fallback: farcaster.actions.ready() called');
                } catch (error) {
                  console.error('‚ùå Fallback SDK error:', error);
                }
              } else if (window.parent !== window) {
                console.log('üì± Fallback: iframe detected, sending ready message');
                window.parent.postMessage({ type: 'ready' }, '*');
              }
            }
          }, 2000);

          return () => clearTimeout(timer);
        }, []);

        // Farcaster Mini App context auto-detection
        useEffect(() => {
          const loadFarcasterContext = async () => {
            try {
              // Try different SDK access patterns
              const sdk = window.farcaster || window.farcasterSDK || window.sdk || window.FarcasterSDK;
              
              if (!sdk) {
                console.log('üì± No Farcaster SDK found - running in regular browser');
                setFcReady(true); // Mark as ready even if no SDK
                return;
              }

              // Call ready() if available
              if (sdk.actions && typeof sdk.actions.ready === 'function') {
                try {
                  await sdk.actions.ready();
                  console.log('‚úÖ Farcaster SDK ready() called');
                } catch (readyError) {
                  console.warn('‚ö†Ô∏è SDK ready() error (non-fatal):', readyError);
                }
              }

              // Get context - try different methods
              let ctx = null;
              if (sdk.context) {
                ctx = sdk.context;
                // If context is a Promise, await it
                if (ctx && typeof ctx.then === 'function') {
                  ctx = await ctx;
                }
              } else if (typeof sdk.getContext === 'function') {
                ctx = await sdk.getContext();
              } else if (sdk.user) {
                // Direct user access
                ctx = { user: sdk.user };
              }

              if (!ctx) {
                console.log('üì± No Farcaster context available');
                setFcReady(true);
                return;
              }

              // Extract user from context
              const user = ctx.user || ctx.viewer || ctx;
              
              if (!user) {
                console.log('üì± No user in Farcaster context');
                setFcReady(true);
                return;
              }

              // Normalize user data
              const normalized = {
                fid: user.fid || user.userFid || null,
                username: user.username || null,
                displayName: user.displayName || user.display_name || null,
                pfpUrl: user.pfpUrl || user.pfp_url || user.avatarUrl || user.avatar_url || null
              };

              if (normalized.fid) {
                console.log('‚úÖ Farcaster user context loaded:', {
                  fid: normalized.fid,
                  username: normalized.username,
                  hasAvatar: !!normalized.pfpUrl
                });

                // Update states
                setFcUser(normalized);
                setUserFid(normalized.fid);
                if (normalized.pfpUrl) {
                  setUserAvatar(normalized.pfpUrl);
                }
              } else {
                console.log('üì± Farcaster context found but no FID');
              }

              setFcReady(true);
            } catch (error) {
              console.warn('‚ö†Ô∏è Error loading Farcaster context (non-fatal):', error);
              setFcReady(true); // Mark as ready even on error
            }
          };

          // Small delay to ensure SDK is initialized
          const timer = setTimeout(() => {
            loadFarcasterContext();
          }, 500);

          return () => clearTimeout(timer);
        }, []);

        // Debug: track gameStage changes after animating
        useEffect(() => {
          if (gameStage === "spread" || gameStage === "reading") {
            // Small delay to ensure DOM is updated
            setTimeout(() => {
              if (window.location.search.includes('debug=1')) {
                console.log('spread sizes (after animating removed)', {
                  vw: window.innerWidth,
                  vh: window.innerHeight,
                  table: getComputedStyle(document.querySelector('.tarot-table'))?.transform || 'none',
                  content: getComputedStyle(document.querySelector('.tarot-table-content'))?.transform || 'none',
                  spread: getComputedStyle(document.querySelector('.tarot-spread'))?.transform || 'none',
                  card: document.querySelector('.tarot-card') ? getComputedStyle(document.querySelector('.tarot-card'))?.transform : null,
                });
              }
            }, 100);
          }
        }, [gameStage]);

        // Function to play button sound
        const playButtonSound = () => {
          if (!soundEnabled) return;
          const audio = new Audio('./public/Assets/audio/tab.mp3');
          audio.volume = 0.3; // Set volume to 30%
          audio.play().catch(e => console.log('Audio play failed:', e));
        };

        // Function to play spread animation sound
        const playSpreadSound = () => {
          if (!soundEnabled) return;
          const audio = new Audio('./public/Assets/audio/spread.mp3');
          audio.volume = 0.4; // Set volume to 40%
          audio.play().catch(e => console.log('Audio play failed:', e));
        };

        // Wallet and payment functions
        // Function to get user avatar from Farcaster
        const getUserAvatar = async (fid) => {
          if (!fid) return null;

          // First check if we have avatar from Farcaster context
          if (fcUser?.fid === fid && fcUser?.pfpUrl) {
            return fcUser.pfpUrl;
          }

          // Fallback to Neynar API only if no context available
          try {
            const response = await fetch(`https://api.neynar.com/v2/farcaster/user/bulk?fids=${fid}`, {
              headers: {
                'api_key': 'NEYNAR_API_DOCS' // Using public API key for demo
              }
            });

            if (response.ok) {
              const data = await response.json();
              const user = data.users?.[0];
              return user?.pfp_url || null;
            }
          } catch (error) {
            console.error('Failed to fetch user avatar:', error);
          }
          return null;
        };

        // Function to get FID from connected wallet
        const getFidFromWallet = async (address) => {
          try {
            // First check if we have FID from Farcaster context
            if (fcUser?.fid) {
              return fcUser.fid;
            }

            // Check if user is already connected via Farcaster Mini App (legacy check)
            if (window.farcaster && window.farcaster.user) {
              return window.farcaster.user.fid;
            }

            // Fallback: Try to get FID via Neynar API using wallet address
            const response = await fetch(`https://api.neynar.com/v2/farcaster/user/bulk-by-address?addresses=${address}`, {
              headers: {
                'api_key': 'NEYNAR_API_DOCS'
              }
            });

            if (response.ok) {
              const data = await response.json();
              const user = data[address]?.[0];
              return user?.fid || null;
            }
          } catch (error) {
            console.error('Failed to get FID:', error);
          }
          return null;
        };

        const connectWallet = async () => {
          // If already connected via authIdentity, use that
          if (authIdentity.walletAddress && authIdentity.authState === 'wallet_connected_profile_ready') {
            try {
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const signer = provider.getSigner();
              return { provider, signer, address: authIdentity.walletAddress };
            } catch (error) {
              console.error('Failed to get provider:', error);
            }
          }

          if (!window.ethereum) {
            alert('MetaMask or compatible wallet not found!');
            return null;
          }

          try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const address = await signer.getAddress();

            setIsWalletConnected(true);
            setWalletAddress(address);

            // If we already have FID/avatar from Farcaster context, don't overwrite
            if (fcUser?.fid && userFid === fcUser.fid && userAvatar === fcUser.pfpUrl) {
              // Already set from context, skip wallet-based lookup
              return { provider, signer, address };
            }

            // Try to get FID and avatar (don't fail if this errors)
            try {
              const fid = await getFidFromWallet(address);
              // Only update if we don't already have it from context
              if (fid && !fcUser?.fid) {
                setUserFid(fid);
              } else if (fid) {
                setUserFid(fid); // Update anyway if wallet provides different FID
              }

              if (fid) {
                try {
                  const avatar = await getUserAvatar(fid);
                  // Only update if we don't already have it from context
                  if (avatar && !fcUser?.pfpUrl) {
                    setUserAvatar(avatar);
                  } else if (avatar) {
                    setUserAvatar(avatar); // Update anyway if wallet provides different avatar
                  }
                } catch (avatarError) {
                  console.warn('Failed to get avatar:', avatarError);
                  // Don't clear if we have it from context
                  if (!fcUser?.pfpUrl) {
                    setUserAvatar(null);
                  }
                }
              } else {
                // Don't clear if we have it from context
                if (!fcUser?.fid) {
                  setUserAvatar(null);
                }
              }
            } catch (fidError) {
              console.warn('Failed to get FID:', fidError);
              // Don't clear if we have it from context
              if (!fcUser?.fid) {
                setUserFid(null);
                setUserAvatar(null);
              }
            }

            return { provider, signer, address };
          } catch (error) {
            console.error('Failed to connect wallet:', error);
            alert('Failed to connect wallet. Please try again.');
            return null;
          }
        };

        const ensureBase = async (provider) => {
          const network = await provider.getNetwork();
          if (network.chainId !== 8453) {
            try {
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x2105' }],
              });
              // Reload provider after network switch
              return new ethers.providers.Web3Provider(window.ethereum);
            } catch (error) {
              console.error('Failed to switch to Base network:', error);
              throw new Error('Please switch to Base network manually');
            }
          }
          return provider;
        };

        const payETH = async (signer, amountETH) => {
          const TREASURY = '0xD4bF185c846F6CAbDaa34122d0ddA43765E754A6';

          const tx = await signer.sendTransaction({
            to: TREASURY,
            value: ethers.utils.parseEther(amountETH.toString())
          });
          const receipt = await tx.wait();

          return { txHash: tx.hash, receipt };
        };


        // Usage Logger Module
        const usageLogger = {
          // Get identity from Mini App context
          getIdentity() {
            // First check Farcaster context state
            let fid = fcUser?.fid || userFid || '';
            let currentWalletAddress = walletAddress || '';

            // Fallback: Try to get FID from Farcaster context (legacy check)
            if (!fid && window.farcaster && window.farcaster.user) {
              fid = window.farcaster.user.fid || '';
            }

            return { fid, walletAddress: currentWalletAddress };
          },

          // Generate storage key for identity
          getStorageKey() {
            const { fid, walletAddress } = this.getIdentity();
            return `cbtaro_usage_${fid || 'unknown'}_${walletAddress || 'unknown'}`;
          },

          // Load counts from localStorage
          loadCounts() {
            const key = this.getStorageKey();
            const stored = localStorage.getItem(key);
            if (stored) {
              try {
                return JSON.parse(stored);
              } catch (e) {
                console.error('Failed to parse usage counts:', e);
              }
            }
            return { oneCardCount: 0, threeCardCount: 0, customCount: 0 };
          },

          // Save counts to localStorage
          saveCounts(counts) {
            const key = this.getStorageKey();
            localStorage.setItem(key, JSON.stringify(counts));
          },

          // Increment count for specific spread type
          increment(type) {
            const counts = this.loadCounts();
            if (type === 'ONE') counts.oneCardCount++;
            else if (type === 'THREE') counts.threeCardCount++;
            else if (type === 'CUSTOM') counts.customCount++;
            this.saveCounts(counts);
          },

          // Export data as CSV
          exportCsv() {
            const { fid, walletAddress } = this.getIdentity();
            const counts = this.loadCounts();

            // Create CSV content
            const csvContent = [
              'fid,walletAddress,oneCardCount,threeCardCount,customCount',
              `${fid},${walletAddress},${counts.oneCardCount},${counts.threeCardCount},${counts.customCount}`
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'cbTARO_usage.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        };

        // Share functions
        const getShareText = (spreadType) => {
          if (spreadType === "ONE") {
            return `üÉè Daily Tarot

Today's card gave me a clear signal.
Sometimes one card is all you need.

üîÆ Pulled with cbTARO on Base`;
          } else if (spreadType === "THREE") {
            return `üîÆ 3-Card Tarot Reading

Past. Present. Direction.
The pattern actually makes sense.

‚ú® Pulled with cbTARO on Base`;
          } else if (spreadType === "CUSTOM") {
            return `üßø Custom Tarot Reading

Asked a real question.
Got a real answer.

‚ú® cbTARO ¬∑ Tarot on Base`;
          }
          return "";
        };

        const generateCardsImage = async (cards) => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 1200;
          canvas.height = 630;

          // Dark background
          ctx.fillStyle = '#0a1230';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Card images
          const cardWidth = 150;
          const cardHeight = cardWidth * 1.46;
          const totalCardsWidth = cards.length * cardWidth + (cards.length - 1) * 20;
          const startX = (canvas.width - totalCardsWidth) / 2;
          const centerY = canvas.height / 2 - cardHeight / 2;

          for (let i = 0; i < cards.length; i++) {
            const card = cards[i];
            const x = startX + i * (cardWidth + 20);
            const y = centerY;

            try {
              try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => {
                  img.onload = resolve;
                  img.onerror = reject;
                  img.src = card.imagePath;
                });

                ctx.drawImage(img, x, y, cardWidth, cardHeight);
              } catch (error) {
                console.warn('Failed to load card image:', card.imagePath, error);
                // Draw placeholder
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(x, y, cardWidth, cardHeight);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, cardWidth, cardHeight);

                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(card.name, x + cardWidth/2, y + cardHeight/2);
              }
            } catch (error) {
              console.error('Failed to load card image:', error);
              // Draw placeholder
              ctx.fillStyle = '#1a1a2e';
              ctx.fillRect(x, y, cardWidth, cardHeight);
              ctx.strokeStyle = '#fff';
              ctx.lineWidth = 2;
              ctx.strokeRect(x, y, cardWidth, cardHeight);

              ctx.fillStyle = '#fff';
              ctx.font = '12px Arial';
              ctx.textAlign = 'center';
              ctx.fillText(card.name, x + cardWidth/2, y + cardHeight/2);
            }
          }

          // Footer text
          ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
          ctx.font = '16px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('cbTARO ¬∑ Tarot on Base', canvas.width / 2, canvas.height - 20);

          return canvas.toDataURL('image/png');
        };

        const generateAITextImage = async (aiText) => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 1200;
          canvas.height = 630;

          // Dark background
          ctx.fillStyle = '#0a1230';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Title
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 24px Georgia, serif';
          ctx.textAlign = 'center';
          ctx.fillText('Custom Tarot Interpretation', canvas.width / 2, 50);

          // AI Text with word wrapping
          ctx.fillStyle = '#fff';
          ctx.font = '18px Georgia, serif';
          ctx.textAlign = 'left';

          const maxWidth = canvas.width - 100;
          const lineHeight = 24;
          let y = 100;

          const words = aiText.split(' ');
          let line = '';

          for (let i = 0; i < words.length; i++) {
            const testLine = line + words[i] + ' ';
            const metrics = ctx.measureText(testLine);
            const testWidth = metrics.width;

            if (testWidth > maxWidth && i > 0) {
              ctx.fillText(line, 50, y);
              line = words[i] + ' ';
              y += lineHeight;
            } else {
              line = testLine;
            }
          }
          ctx.fillText(line, 50, y);

          return canvas.toDataURL('image/png');
        };

        const handleShare = async () => {
          try {
            playButtonSound();

            const shareText = getShareText(selectedSpread);
            const embeds = [];

            // Use static images instead of generated dataURL (better for embeds)
            // For cards, use a generic tarot image
            embeds.push('https://0xagcheth.github.io/cbTARO/Assets/imagine/b.png');

            // For CUSTOM, add another image if AI interpretation exists
            if (selectedSpread === "CUSTOM" && aiInterpretation) {
              embeds.push('https://0xagcheth.github.io/cbTARO/Assets/imagine/cr.png');
            }

            // Add app URL
            embeds.push('https://0xagcheth.github.io/cbTARO/');

            // Create Warpcast intent URL
            const baseUrl = 'https://warpcast.com/~/compose';
            const params = new URLSearchParams({
              text: shareText,
            });

            embeds.forEach((embed, index) => {
              params.append(`embeds[${index}]`, embed);
            });

            const shareUrl = `${baseUrl}?${params.toString()}`;

            // Open in new window/tab
            window.open(shareUrl, '_blank', 'noopener,noreferrer');

          } catch (error) {
            console.error('Share failed:', error);
            alert('Failed to share reading. Please try again.');
          }
        };

        // 1. Click "Choose Your Spread"
        const handleChooseSpreadClick = () => {
          playButtonSound();
          setGameStage("choosing");
        };

        // Function to get AI interpretation using free API
        const getAIInterpretation = async (cards, question) => {
          try {
            // Using Hugging Face Inference API (free tier)
            // You can also use other free APIs like Groq, Cohere, etc.
            const cardNames = cards.map(c => c.name).join(", ");
            const cardKeywords = cards.map(c => c.keyword).join(", ");
            const cardDescriptions = cards.map(c => c.description).join("\n");

            const prompt = `You are a master tarot reader who creates deeply personalized, spiritually resonant interpretations based on the unique energies of each card combination.

CRITICAL: Respond ONLY in English, regardless of the question's language. Always provide the reading in English.

The seeker asked: "${question}"

Here are the specific cards drawn in this unique reading:

${cards.map((c, i) =>
  `Position ${i + 1}: ${c.positionLabel}
Card: ${c.name} (Keyword: ${c.keyword})
Meaning: ${c.description}`
).join("\n\n")}

Now, create a bespoke interpretation that weaves these specific card energies together. Analyze how these particular cards interact and what their unique combination reveals about the seeker's situation.

Focus deeply on:
- The specific symbolism and energies of each individual card
- How these cards relate to each other in this spread
- The unique message this card combination creates for this question
- The spiritual wisdom this particular set of cards brings

Structure your mystical guidance:

üåü **Divine Message from the Cards** - Interpret the unique energies and symbolism of this specific card combination
‚ö° **Sacred Actions to Consider** - Practical spiritual steps based on these particular cards' guidance
üîÆ **Mystic Awareness** - Important insights and potential challenges revealed by this card spread
‚ú® **Soul's Journey** - The deeper spiritual meaning and hope this reading brings

Make this reading feel like it was crafted specifically for this seeker with this exact card combination. Reference the specific cards by name and connect their meanings in meaningful ways. Avoid generic advice - be specific to these cards' energies and symbolism.

Important: This must be a unique interpretation for this specific card spread. Make it feel personal, spiritually deep, and directly connected to these particular cards. Always respond in English.`;

            // Using Hugging Face Inference API with a free model
            const response = await fetch(
              "https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  // Note: For production, you'd need to add your API key
                  // "Authorization": "Bearer YOUR_HUGGINGFACE_API_KEY"
                },
                body: JSON.stringify({
                  inputs: prompt,
                  parameters: {
                    max_new_tokens: 300,
                    temperature: 0.7,
                    return_full_text: false
                  }
                })
              }
            );

            if (!response.ok) {
              // Fallback to a simple interpretation if API fails
              return generateFallbackInterpretation(cards, question);
            }

            const data = await response.json();
            return data[0]?.generated_text || generateFallbackInterpretation(cards, question);
          } catch (error) {
            console.error("AI API error:", error);
            // Fallback interpretation
            return generateFallbackInterpretation(cards, question);
          }
        };

        // Fallback interpretation if API is unavailable
        const generateFallbackInterpretation = (cards, question) => {
          const cardNames = cards.map(c => c.name).join(", ");
          const themes = cards.map(c => c.keyword).join(", ");

          const cardDetails = cards.map((c, i) =>
            `${c.name} in the ${c.positionLabel} position brings ${c.keyword.toLowerCase()} energy`
          ).join(". ");

          return `üåü **Divine Message from the Cards:** The sacred combination of ${cardNames} creates a unique spiritual tapestry for your question "${question}". ${cardDetails}. This rare alignment speaks of transformation and divine timing.

‚ö° **Sacred Actions to Consider:** Drawing from the specific wisdom of ${cards[0].name}'s ${cards[0].keyword.toLowerCase()} energy, consider embracing new perspectives. The ${cards[1].name} suggests deepening your intuitive connection, while ${cards[2].name} guides you toward authentic action that honors your soul's purpose.

üîÆ **Mystic Awareness:** Pay special attention to the ${cards[1].name}'s message about balance and harmony. This card warns against forcing outcomes - trust the natural flow revealed by this divine arrangement.

‚ú® **Soul's Journey:** This unique card spread carries the blessing of ${themes}. Each card contributes its sacred energy to guide you toward greater wisdom and spiritual growth. Trust that this specific combination appeared for your highest good.`;
        };

        // 2. Select specific spread (1, 3, or CUSTOM cards)
        const handleSelectSpread = async (spread) => {
          setSelectedSpread(spread);
          setAiInterpretation(null);

          // Handle different payment requirements
          if (spread === "ONE") {
            // Free - log usage and start animation
            usageLogger.increment("ONE");
            await startSpreadAnimation(spread);
          } else if (spread === "THREE") {
            // Pay 0.0001 ETH each time for 3-card spread
            try {
              setTxStatus("paying");
              const wallet = await connectWallet();
              if (!wallet) {
                setTxStatus("error");
                alert("Please connect your wallet first");
                return;
              }

              const provider = await ensureBase(wallet.provider);
              const signer = provider.getSigner();

              const result = await payETH(signer, 0.0001);
              setTxHash(result.txHash);
              setTxStatus("success");

              // Log usage and start animation
              usageLogger.increment("THREE");

              // Small delay to show success
              setTimeout(() => {
                setTxStatus("idle");
                startSpreadAnimation(spread);
              }, 2000);
            } catch (error) {
              console.error("Payment failed:", error);
              setTxStatus("error");
              if (error.message.includes("user rejected")) {
                alert("Payment cancelled. 3-card reading requires 0.0001 ETH payment.");
              } else {
                alert(`Payment failed: ${error.message}`);
              }
              return;
            }
          } else if (spread === "CUSTOM") {
            // Pay 0.0005 ETH for custom reading
            try {
              setTxStatus("paying");
              const wallet = await connectWallet();
              if (!wallet) {
                setTxStatus("error");
                alert("Please connect your wallet first");
                return;
              }

              const provider = await ensureBase(wallet.provider);
              const signer = provider.getSigner();

              const result = await payETH(signer, 0.0005);
              setTxHash(result.txHash);
              setTxStatus("success");

              // Log usage and start animation
              usageLogger.increment("CUSTOM");

              // Small delay to show success
              setTimeout(() => {
                setTxStatus("idle");
                startSpreadAnimation(spread);
              }, 2000);
            } catch (error) {
              console.error("Payment failed:", error);
              setTxStatus("error");
              if (error.message.includes("user rejected")) {
                alert("Payment cancelled. Custom reading requires 0.0005 ETH payment.");
              } else {
                alert(`Payment failed: ${error.message}`);
              }
              return;
            }
          }
        };

        const startSpreadAnimation = async (spread) => {
          setIsLoading(true);

          try {
            // Small pause for smoothness
            await new Promise((resolve) => setTimeout(resolve, 300));

            playSpreadSound();
            setGameStage("animating");

            // Small pause for "magical animation"
            setTimeout(async () => {
              let count = 3; // Default for custom
              if (spread === "ONE") count = 1;
              else if (spread === "THREE") count = 3;
              else if (spread === "CUSTOM") count = 3; // Custom always uses 3 cards

              const newCards = getRandomCards(count);

              // Add positional labels based on spread type
              if (spread === "THREE") {
                const labeled = newCards.map((card, idx) => ({
                  ...card,
                  positionLabel:
                    idx === 0
                      ? "Today's Energy"
                      : idx === 1
                      ? "Support"
                      : "Challenge",
                }));
                setCards(labeled);
              } else if (spread === "CUSTOM") {
                const labeled = newCards.map((card, idx) => ({
                  ...card,
                  positionLabel:
                    idx === 0
                      ? "Past/Foundation"
                      : idx === 1
                      ? "Present/Situation"
                      : "Future/Guidance",
                }));
                setCards(labeled);

                // Don't generate AI interpretation yet - wait for user to reveal all cards
              } else {
                setCards(newCards);
              }

              setRevealedIds([]);
              setActiveCard(null);
              setGameStage("spread");
              
              // Debug log after spread
              setTimeout(() => {
                if (window.location.search.includes('debug=1')) {
                  console.log('spread sizes', {
                    vw: window.innerWidth,
                    vh: window.innerHeight,
                    table: getComputedStyle(document.querySelector('.tarot-table'))?.transform || 'none',
                    content: getComputedStyle(document.querySelector('.tarot-table-content'))?.transform || 'none',
                    spread: getComputedStyle(document.querySelector('.tarot-spread'))?.transform || 'none',
                    card: document.querySelector('.tarot-card') ? getComputedStyle(document.querySelector('.tarot-card'))?.transform : null,
                  });
                }
              }, 100);
            }, 1200);
          } catch (err) {
            console.error("Error:", err);
            setGameStage(spread === "CUSTOM" ? "custom" : "idle");
          } finally {
            setIsLoading(false);
          }
        };

        // Generate AI interpretation when all cards are revealed in custom reading
        const generateCustomInterpretation = async (revealedIdsArray) => {
          const allRevealed = cards.length > 0 && cards.every((c) => revealedIdsArray.includes(c.id));
          if (selectedSpread === "CUSTOM" && allRevealed && !aiInterpretation && userQuestion.trim()) {
            setIsGeneratingAI(true);
            try {
            const interpretation = await getAIInterpretation(cards, userQuestion);
            setAiInterpretation(interpretation);
            } catch (error) {
              console.error('AI interpretation failed:', error);
              alert('Failed to generate AI interpretation. Please try again.');
            } finally {
            setIsGeneratingAI(false);
            }
          }
        };

        // 3. Click on card ‚Üí flip + show description
        const handleCardClick = (card) => {
          playButtonSound();
          // Set reading source to 'spread' when clicking card in spread
          setReadingSource('spread');
          
          // If card is already revealed ‚Äî show description
          if (revealedIds.includes(card.id)) {
            setActiveCard(card);
            setGameStage("reading");
            return;
          }

          // Add card to revealed list and check if all are revealed
          setRevealedIds((prev) => {
            const newRevealedIds = [...prev, card.id];
            // Check if this was the last card in custom reading
            if (selectedSpread === "CUSTOM" && newRevealedIds.length === cards.length && userQuestion.trim()) {
              // Small delay before generating interpretation
              setTimeout(() => {
                generateCustomInterpretation(newRevealedIds);
              }, 1000);
            }
            return newRevealedIds;
          });
          setActiveCard(card);
          setGameStage("reading");
        };

        // 4. Close card description (click on background / "Close" button)
        const handleCloseReading = () => {
          const source = readingSource;
          setReadingSource(null);
          
          if (source === 'gallery') {
            // Return to gallery - just close the overlay, keep gallery open
            setActiveCard(null);
            // Keep showGallery=true and gameStage as is
            return;
          } else if (source === 'spread') {
            // Return to spread
            if (cards.some((c) => !revealedIds.includes(c.id))) {
              setGameStage("spread");
            } else {
              // All cards revealed ‚Üí theoretically can show "New Reading" button
              setGameStage("spread");
            }
            setActiveCard(null);
          } else if (source === 'ai') {
            // Return to AI panel (if needed in future)
            setActiveCard(null);
            // Keep gameStage as is for AI interpretation
          } else {
            // Fallback: default behavior (return to spread)
            if (cards.some((c) => !revealedIds.includes(c.id))) {
              setGameStage("spread");
            } else {
              setGameStage("spread");
            }
            setActiveCard(null);
          }
        };

        // 5. New reading (reset state)
        const handleNewSpread = () => {
          setGameStage("idle");
          setSelectedSpread(null);
          setCards([]);
          setRevealedIds([]);
          setActiveCard(null);
          setTxHash(null);
          setUserQuestion("");
          setAiInterpretation(null);
        };

        const isAllRevealed = cards.length > 0 && cards.every((c) => revealedIds.includes(c.id));

        return (
          <div className="tarot-root">
            {/* Mystical background */}
            <div className="tarot-background" />

            {/* Unified Identity Button */}
            <UnifiedIdentityButton playButtonSound={playButtonSound} />

            {/* Sound toggle button - positioned under wallet button */}
            <button
              className="sound-toggle-btn sound-toggle-btn-left"
              onClick={(e) => { 
                e.stopPropagation();
                if (soundEnabled) playButtonSound();
                setSoundEnabled(!soundEnabled);
              }}
              title={soundEnabled ? "Disable sound" : "Enable sound"}
            >
              {soundEnabled ? "üîä" : "üîá"}
            </button>

            <div className="tarot-container">
              {/* Header / greeting */}
              <header className="tarot-header">
                <h1>cbTaro</h1>

                {/* Transaction status - moved below title */}
                {txStatus !== 'idle' && (
                  <div className="tx-status">
                    {txStatus === 'paying' && <span>üîÑ Confirm in wallet...</span>}
                    {txStatus === 'success' && <span>‚úÖ Payment successful!</span>}
                    {txStatus === 'error' && <span>‚ùå Payment failed</span>}
                    {txHash && <div className="tx-hash">TX: {txHash.slice(0, 10)}...{txHash.slice(-8)}</div>}
                  </div>
                )}
              </header>

              {/* Small block with hash after "payment" (hidden, as payment is disabled) */}
              {txHash && (
                <div className="tarot-hash">
                  <span>Your reading is recorded:</span>
                  <code>{txHash}</code>
                </div>
              )}

              {/* Main area with table and deck/cards */}
              <main className="tarot-main">
                {/* Control buttons container - moved outside tarot-table */}
                <div className="control-buttons">
                  {/* Gallery button */}
                  <button
                    className="gallery-button"
                    onClick={(e) => { 
                      e.stopPropagation();
                      playButtonSound();
                      setPreviousGameStage(gameStage);
                      setShowGallery(true);
                    }}
                    title="View all tarot cards"
                  >
                    ‚ò∞
                  </button>
                </div>

                {/* Fixed Oval Table - always same size and position */}
                <div className="tarot-table-wrap">
                  <div className={`tarot-table ${gameStage === "animating" ? "table-animating" : ""}`}>
                    {/* Content overlay - all content is absolutely positioned */}
                    <div className="tarot-table-content">
                    {/* When there's no spread ‚Äî show deck */}
                    {gameStage === "idle" && (
                      <div className="tarot-deck" onClick={handleChooseSpreadClick}>
                        <div className="tarot-deck-inner" />
                      </div>
                    )}

                    {/* Card spread (1 or 3 cards) */}
                    {(gameStage === "spread" || gameStage === "reading") && (
                      <div className="tarot-spread">
                        {cards.map((card, index) => {
                          const isRevealed = revealedIds.includes(card.id);
                          const spreadType = selectedSpread;
                          const offsetClass =
                            spreadType === "THREE"
                              ? index === 0
                                ? "card-left"
                                : index === 1
                                ? "card-center"
                                : "card-right"
                              : "card-single";

                          return (
                            <div
                              key={card.id}
                              className={`card-slot ${offsetClass}`}
                            >
                              <div
                                className={`card-anim ${isRevealed ? "card-revealed" : ""}`}
                                onClick={() => handleCardClick(card)}
                                onAnimationEnd={(e) => {
                                  // Reset transform after animation to prevent scale "sticking"
                                  const animEl = e.currentTarget;
                                  const finalRot = offsetClass === 'card-left' ? -15 : offsetClass === 'card-right' ? 15 : 0;
                                  animEl.style.transform = `translate3d(0, 0, 0) rotate(${finalRot}deg) scale(1)`;
                                  animEl.style.opacity = '1';
                                }}
                              >
                                <div className="tarot-card-inner">
                                  {/* Card back */}
                                  <div className="tarot-card-back"></div>

                                  {/* Card face */}
                                  <div className="tarot-card-front">
                                    {card.imagePath ? (
                                      <img
                                        src={card.imagePath}
                                        alt={card.name}
                                        className="tarot-card-image"
                                        onError={(e) => {
                                          console.error('Failed to load image:', card.imagePath);
                                          e.target.style.display = 'none';
                                          // Show fallback content
                                          e.target.parentElement.innerHTML = `
                                            <div class="tarot-card-fallback">
                                              <div class="tarot-card-name">${card.name}</div>
                                              <div class="tarot-card-keyword">${card.keyword}</div>
                                            </div>
                                          `;
                                        }}
                                      />
                                    ) : (
                                      <div className="tarot-card-fallback">
                                        <div className="tarot-card-name">{card.name}</div>
                                        <div className="tarot-card-keyword">{card.keyword}</div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}

                    {/* Custom reading modal - positioned inside table oval */}
                    {gameStage === "custom" && (
                      <div className="tarot-modal custom-reading-modal">
                        <div className="custom-modal-content">
                          <textarea
                            className="custom-modal-input"
                            placeholder="What would you like to know? Ask in any language! (e.g., 'Will I find love this year?', 'What should I focus on in my career?', '¬øEncontrar√© el amor este a√±o?')"
                            value={userQuestion}
                            onChange={(e) => setUserQuestion(e.target.value)}
                            rows={4}
                            disabled={isLoading}
                          />
                          <div className="custom-modal-actions">
                            <button
                              className="custom-modal-btn secondary"
                              onClick={() => {
                                setGameStage("choosing");
                                setUserQuestion("");
                              }}
                              disabled={isLoading}
                            >
                              &lt;
                            </button>
                            <button
                              className="custom-modal-btn primary"
                              onClick={() => handleSelectSpread("CUSTOM")}
                              disabled={isLoading || !userQuestion.trim()}
                            >
                              {isLoading ? "Reading..." : "‚ú®"}
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Spread selection modal - positioned inside table oval */}
                    {gameStage === "choosing" && (
                      <div 
                        className="tarot-modal choosing-modal"
                        onClick={(e) => {
                          // Close modal if clicking on the background (not on content)
                          const clickedElement = e.target;
                          const isContentClick = clickedElement.closest('.spread-option') ||
                                                clickedElement.closest('.modal-bottom-buttons') ||
                                                clickedElement.closest('.custom-reading-overlay-button');
                          
                          if (!isContentClick) {
                            playButtonSound();
                            setGameStage("idle");
                          }
                        }}
                      >
                        <div 
                          className="spread-selection"
                          onClick={(e) => {
                            // Return to main screen if clicking on spread-selection (not on cards)
                            if (e.target === e.currentTarget || !e.target.closest('.spread-option')) {
                              playButtonSound();
                              setGameStage("idle");
                            }
                          }}
                        >
                          {/* Single card on the left */}
                          <div
                            className="spread-option single-card-option"
                            onClick={(e) => {
                              e.stopPropagation();
                              if (!isLoading) {
                                playButtonSound();
                                handleSelectSpread("ONE");
                              }
                            }}
                            style={{ opacity: isLoading ? 0.5 : 1, cursor: isLoading ? 'not-allowed' : 'pointer' }}
                          >
                            <div className="spread-preview">
                              <div className="preview-card single-preview-card">
                                <div className="preview-card-inner">
                                  <div className="preview-card-back"></div>
                                  <div className="preview-card-front">
                                    <img
                                      src="./public/Assets/imagine/taro_cards/THE FOOL.png"
                                      alt="Single Card"
                                      className="preview-card-image"
                                      onError={(e) => {
                                        e.target.src = "./public/Assets/imagine/taro_cards/THE MAGICIAN.png";
                                      }}
                                    />
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Three cards on the right */}
                          <div
                            className="spread-option three-cards-option"
                            onClick={(e) => {
                              e.stopPropagation();
                              if (!isLoading) {
                                playButtonSound();
                                handleSelectSpread("THREE");
                              }
                            }}
                            style={{ opacity: isLoading ? 0.5 : 1, cursor: isLoading ? 'not-allowed' : 'pointer' }}
                          >
                            <div className="spread-preview">
                              <div className="preview-card three-preview-card left-card">
                                <div className="preview-card-inner">
                                  <div className="preview-card-back"></div>
                                  <div className="preview-card-front">
                                    <img
                                      src="./public/Assets/imagine/taro_cards/THE FOOL.png"
                                      alt="Three Cards"
                                      className="preview-card-image"
                                    />
                                  </div>
                                </div>
                              </div>
                              <div className="preview-card three-preview-card center-card">
                                <div className="preview-card-inner">
                                  <div className="preview-card-back"></div>
                                  <div className="preview-card-front">
                                    <img
                                      src="./public/Assets/imagine/taro_cards/THE MAGICIAN.png"
                                      alt="Three Cards"
                                      className="preview-card-image"
                                    />
                                  </div>
                                </div>
                              </div>
                              <div className="preview-card three-preview-card right-card">
                                <div className="preview-card-inner">
                                  <div className="preview-card-back"></div>
                                  <div className="preview-card-front">
                                    <img
                                      src="./public/Assets/imagine/taro_cards/THE HIGH PRIESTESS.png"
                                      alt="Three Cards"
                                      className="preview-card-image"
                                    />
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Bottom buttons container */}
                        <div className="modal-bottom-buttons">
                          <button
                            className="custom-reading-overlay-button"
                            disabled={isLoading}
                            onClick={() => { playButtonSound(); setGameStage("custom"); }}
                          >
                            <img
                              src="./public/Assets/imagine/cr.png"
                              alt="Custom Reading"
                              className="custom-reading-underlay-image"
                            />
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Interaction panel at bottom - positioned inside table oval */}
                    <footer className="tarot-footer">
                      {isAllRevealed && gameStage !== "paying" && (
                        <>
                          {selectedSpread === "CUSTOM" && (
                            <>
                              {!aiInterpretation && !isGeneratingAI && (
                                <button
                                  className="tarot-button"
                                  onClick={() => {
                                    playButtonSound();
                                    if (!userQuestion.trim()) {
                                      alert('Please enter your question before getting a reading.');
                                      return;
                                    }
                                    generateCustomInterpretation(revealedIds);
                                  }}
                                  style={{ marginRight: "1rem" }}
                                  disabled={isGeneratingAI}
                                >
                                  {isGeneratingAI ? "Generating..." : "Get Reading"}
                                </button>
                              )}
                              {isGeneratingAI && (
                                <div className="tarot-generating" style={{ marginRight: "1rem", color: "#ffd700" }}>
                                  ‚ú® Generating reading...
                                </div>
                              )}
                              {aiInterpretation && (
                                <button
                                  className="tarot-button"
                                  onClick={() => { playButtonSound(); setActiveCard(null); setGameStage("reading"); }}
                                  style={{ marginRight: "1rem" }}
                                >
                                  View AI Reading
                                </button>
                              )}
                            </>
                          )}
                          <button className="tarot-button secondary" onClick={() => { playButtonSound(); handleNewSpread(); }}>
                            &lt;
                          </button>
                          <button className="tarot-button" onClick={() => { playButtonSound(); handleShare(); }}>
                            Share
                          </button>
                        </>
                      )}
                    </footer>
                  </div>
                </div>
                </div>

                {/* Payment state (not used, as payment is disabled) */}
                {gameStage === "paying" && (
                  <div className="tarot-modal">
                    <h2>Processing Transaction‚Ä¶</h2>
                    <p>Please confirm payment in your wallet.</p>
                  </div>
                )}

                {/* Animation before spread */}
                {gameStage === "animating" && (
                  <div className="tarot-animating">
                  </div>
                )}
              </main>

            {/* Gallery modal */}
            {showGallery && (
              <div className="tarot-reading-overlay" onClick={() => setShowGallery(false)}>
                <div className="gallery-modal" onClick={(e) => e.stopPropagation()}>
                  <div className="gallery-content">
                    {/* Major Arcana */}
                    <div className="gallery-section">
                      <h3>Major Arcana</h3>
                      <div className="gallery-grid">
                        {ALL_CARDS.slice(0, 22).map((card) => (
                          <div key={card.id} className="gallery-card" onClick={() => {
                            playButtonSound();
                            setReadingSource('gallery');
                            setActiveCard(card);
                            setGameStage("reading");
                            // Keep showGallery=true - overlay will be on top
                          }}>
                            <img src={card.imagePath} alt={card.name} />
                            <div className="gallery-card-info">
                              <div className="gallery-card-name">{card.name}</div>
                              <div className="gallery-card-keyword">{card.keyword}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Wands */}
                    <div className="gallery-section">
                      <h3>Wands</h3>
                      <div className="gallery-grid">
                        {ALL_CARDS.slice(22, 36).map((card) => (
                          <div key={card.id} className="gallery-card" onClick={() => {
                            playButtonSound();
                            setReadingSource('gallery');
                            setActiveCard(card);
                            setGameStage("reading");
                            // Keep showGallery=true - overlay will be on top
                          }}>
                            <img src={card.imagePath} alt={card.name} />
                            <div className="gallery-card-info">
                              <div className="gallery-card-name">{card.name}</div>
                              <div className="gallery-card-keyword">{card.keyword}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Cups */}
                    <div className="gallery-section">
                      <h3>Cups</h3>
                      <div className="gallery-grid">
                        {ALL_CARDS.slice(36, 50).map((card) => (
                          <div key={card.id} className="gallery-card" onClick={() => {
                            playButtonSound();
                            setReadingSource('gallery');
                            setActiveCard(card);
                            setGameStage("reading");
                            // Keep showGallery=true - overlay will be on top
                          }}>
                            <img src={card.imagePath} alt={card.name} />
                            <div className="gallery-card-info">
                              <div className="gallery-card-name">{card.name}</div>
                              <div className="gallery-card-keyword">{card.keyword}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Swords */}
                    <div className="gallery-section">
                      <h3>Swords</h3>
                      <div className="gallery-grid">
                        {ALL_CARDS.slice(50, 64).map((card) => (
                          <div key={card.id} className="gallery-card" onClick={() => {
                            playButtonSound();
                            setReadingSource('gallery');
                            setActiveCard(card);
                            setGameStage("reading");
                            // Keep showGallery=true - overlay will be on top
                          }}>
                            <img src={card.imagePath} alt={card.name} />
                            <div className="gallery-card-info">
                              <div className="gallery-card-name">{card.name}</div>
                              <div className="gallery-card-keyword">{card.keyword}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Pentacles */}
                    <div className="gallery-section">
                      <h3>Pentacles</h3>
                      <div className="gallery-grid">
                        {ALL_CARDS.slice(64, 78).map((card) => (
                          <div key={card.id} className="gallery-card" onClick={() => {
                            playButtonSound();
                            setReadingSource('gallery');
                            setActiveCard(card);
                            setGameStage("reading");
                            // Keep showGallery=true - overlay will be on top
                          }}>
                            <img src={card.imagePath} alt={card.name} />
                            <div className="gallery-card-info">
                              <div className="gallery-card-name">{card.name}</div>
                              <div className="gallery-card-keyword">{card.keyword}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  <button className="gallery-close-btn" onClick={() => { 
                    playButtonSound(); 
                    setShowGallery(false); 
                    setGameStage(previousGameStage);
                    setReadingSource(null);
                    setActiveCard(null);
                  }}>
                    Close Gallery
                  </button>
                </div>
              </div>
            )}

            {/* Reading panel (card description) - rendered AFTER gallery to be on top */}
            {activeCard && (gameStage === "reading" || readingSource === 'gallery') && (
              <div className="tarot-reading-overlay" style={{ zIndex: 2100 }} onClick={handleCloseReading}>
                <div className="tarot-reading-panel" onClick={(e) => e.stopPropagation()}>
                  <h2>{activeCard.name}</h2>
                  {activeCard.imagePath && (
                    <div className="tarot-reading-card-image">
                      <img src={activeCard.imagePath} alt={activeCard.name} />
                    </div>
                  )}
                  {activeCard.positionLabel && (
                    <p className="tarot-reading-position">{activeCard.positionLabel}</p>
                  )}
                  <p className="tarot-reading-keyword">Keyword: {activeCard.keyword}</p>
                  <p className="tarot-reading-text">{activeCard.description}</p>
                </div>
              </div>
            )}

            {/* AI Interpretation panel for custom reading */}
            {selectedSpread === "CUSTOM" && isAllRevealed && aiInterpretation && (
              <div className="tarot-reading-overlay" onClick={() => setAiInterpretation(null)}>
                <div className="tarot-reading-panel tarot-ai-panel" onClick={(e) => e.stopPropagation()}>
                  <h2>‚ú® Your Personalized Reading</h2>
                  <p className="tarot-reading-question">Question: "{userQuestion}"</p>
                  {isGeneratingAI ? (
                    <div className="tarot-ai-loading">
                      Generating reading...
                    </div>
                  ) : (
                    <div dangerouslySetInnerHTML={{ __html: aiInterpretation.replace(/\n/g, '<br/>') }} />
                  )}
                  <button className="tarot-button" onClick={() => setAiInterpretation(null)}>
                    Close
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    // Debug mode viewport updater
    function updateViewportInfo() {
      const body = document.body;
      if (body.dataset.debug === "1") {
        const width = window.innerWidth;
        const height = window.innerHeight;
        body.dataset.viewport = `${width}x${height}`;
      }
    }

    window.addEventListener('resize', updateViewportInfo);
    updateViewportInfo();

    root.render(<TarotApp />);
  </script>

  <style>
    /* Global CSS Reset for Mobile Stability */
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      padding-top: var(--safe-area-inset-top, 0);
      padding-bottom: var(--safe-area-inset-bottom, 0);
      padding-left: var(--safe-area-inset-left, 0);
      padding-right: var(--safe-area-inset-right, 0);
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #root {
      height: 100%;
      width: 100%;
      position: relative;
    }

    /* Safe Area Inset Variables for iOS Notch */
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0);
      --safe-area-inset-left: env(safe-area-inset-left, 0);
      --safe-area-inset-right: env(safe-area-inset-right, 0);

      /* Dynamic viewport height for mobile WebView compatibility */
      --vh: 1vh;

      /* Mobile-first responsive scaling variables */
      --pad: clamp(12px, 3vw, 32px);
      --space: var(--pad); /* alias for backwards compatibility */
      --tableW: min(92vw, 820px);
      --tableAR: 1 / 0.72; /* portrait aspect ratio */
      --card-w: clamp(92px, 22vw, 140px);
      --card-ratio: 1.55;
      --card-h: calc(var(--card-w) * var(--card-ratio));
      /* Legacy support */
      --cardW: var(--card-w);
      --cardH: var(--card-h);
      --deckW: clamp(100px, 24vw, 140px);
      --deckH: calc(var(--deckW) * 1.46);
      --h1: clamp(20px, 5vw, 36px);
      --p: clamp(12px, 3vw, 16px);
    }

    @media (orientation: landscape) and (max-height: 500px) {
      :root {
        --tableAR: 1 / 0.5;
        --card-w: clamp(92px, 26vw, 132px);
        --cardW: var(--card-w);
        --deckW: clamp(87px, 21vw, 127px);
      }

      /* Adjust footer position for landscape - still positioned at bottom of oval */
      .tarot-footer {
        bottom: calc(var(--pad) * 0.2) !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        max-width: calc(var(--tableW) - var(--pad) * 2) !important;
      }
    }

    /* Background */
    .tarot-root {
      position: relative;
      min-height: calc(var(--vh, 1vh) * 100);
      width: 100%;
      overflow-x: hidden;
      font-family: 'Georgia', 'Times New Roman', serif;
    }

      .tarot-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: calc(var(--vh, 1vh) * 100);
      background-image: url('./public/Assets/imagine/b.png');
      background-repeat: no-repeat;
      background-attachment: scroll; /* Fixed attachment causes issues in WebView */
      z-index: 0;
        background-size: cover;
        background-position: center center;
    }

    @media (max-width: 768px) {
      .tarot-background {
        background-attachment: scroll;
        background-position: center 40%;
      }
      }

    @media (max-width: 768px) and (max-height: 700px) {
      .tarot-background { background-position: center 35%; }
    }

    .tarot-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      animation: backgroundPulse 8s ease-in-out infinite;
    }

    @keyframes backgroundPulse {
      0%, 100% {
        opacity: 0.5;
      }
      50% {
        opacity: 0.8;
      }
    }

    .tarot-root, .tarot-container{
      padding-top: calc(70px + env(safe-area-inset-top));
    }

    .tarot-container {
      position: relative;
      z-index: 1;
      min-height: calc(var(--vh, 1vh) * 100);
      display: flex;
      flex-direction: column;
      padding: calc(var(--pad) + 76px + var(--safe-area-inset-top, 0)) var(--pad) var(--pad) var(--pad);
      width: 100%;
      box-sizing: border-box;
    }

    .tarot-header {
      text-align: center;
      margin-bottom: 0.25rem;
      color: #fff;
    }

    .tarot-header h1 {
      font-size: calc(var(--h1) * 1.2);
      margin: 0;
      position: fixed;
      top: calc(25px + var(--safe-area-inset-top, 0));
      left: 0;
      right: 0;
      width: 100%;
      display: block;
      text-align: center;
      z-index: 1001;
      color: rgba(255, 255, 255, 0.9);
      text-shadow:
        0 0 5px rgba(0, 123, 255, 0.8),
        0 0 10px rgba(0, 123, 255, 0.6),
        0 0 15px rgba(0, 123, 255, 0.4),
        0 0 20px rgba(255, 255, 255, 0.2);
      animation: liquidText 4s ease-in-out infinite;
    }

    .tarot-header h1::before {
      content: 'cbTaro';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      color: rgba(255, 255, 255, 0.1);
      text-shadow:
        0 0 10px rgba(0, 123, 255, 0.5),
        0 0 20px rgba(0, 123, 255, 0.3),
        0 0 30px rgba(255, 255, 255, 0.2);
      filter: blur(1px);
      animation: liquidFlow 6s ease-in-out infinite;
      z-index: -1;
    }

    .tarot-header h1::after {
      content: 'cbTaro';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg,
        rgba(0, 123, 255, 0.1),
        rgba(255, 255, 255, 0.2),
        rgba(0, 123, 255, 0.1));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: blur(0.5px);
      animation: liquidShimmer 3s ease-in-out infinite alternate;
      z-index: -2;
    }

    @keyframes titleGlow {
      0%, 100% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.3);
      }
    }

    @keyframes liquidText {
      0%, 100% {
        transform: scale(1);
        filter: brightness(1) blur(0px);
      }
      50% {
        transform: scale(1.01);
        filter: brightness(1.1) blur(0.5px);
      }
    }

    @keyframes liquidFlow {
      0%, 100% {
        transform: translateX(0px) scale(1);
      }
      25% {
        transform: translateX(1px) scale(1.005);
      }
      50% {
        transform: translateX(0px) scale(1);
      }
      75% {
        transform: translateX(-1px) scale(0.995);
      }
    }

    @keyframes liquidShimmer {
      0% {
        opacity: 0.3;
        filter: hue-rotate(0deg);
      }
      100% {
        opacity: 0.7;
        filter: hue-rotate(10deg);
      }
    }

    .tarot-header p {
      font-size: calc(var(--p) * 0.7);
      color: rgba(255, 255, 255, 0.8);
      margin: 0;
    }

    /* Payment info */
    .payment-info {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .payment-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .payment-label {
      opacity: 0.8;
    }

    .payment-price {
      font-weight: 600;
      color: #4ade80;
    }

    .payment-price[data-unlocked="true"] {
      color: #fbbf24;
    }

    /* Transaction status */
    .tx-status {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(0, 123, 255, 0.1);
      border: 1px solid rgba(0, 123, 255, 0.3);
      border-radius: 8px;
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .tx-hash {
      margin-top: 0.25rem;
      font-family: monospace;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .tarot-hash {
      text-align: center;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      margin-bottom: 1rem;
      color: #fff;
    }

    .tarot-hash code {
      display: block;
      margin-top: 0.5rem;
      font-family: 'Courier New', monospace;
      color: #4ade80;
      word-break: break-all;
    }

    .tarot-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: var(--pad) 0;
      min-height: 0;
    }

    /* Wrapper for table - handles translateY positioning */
    .tarot-table-wrap {
      position: relative;
      transform: translateY(-10vh);
      transform-origin: center center;
      will-change: transform;
    }

    /* Fixed Oval Table - always same size and position */
    .tarot-table {
      position: relative;
      width: var(--tableW);
      aspect-ratio: var(--tableAR);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow:
        0 0 80px rgba(0, 123, 255, 0.4),
        0 0 160px rgba(0, 123, 255, 0.2),
        inset 0 0 30px rgba(255, 255, 255, 0.05);
      margin: calc(var(--pad) * 0.1) auto;
      transition: box-shadow 0.3s ease;
      transform-origin: center center;
      transform: translateZ(0);
      overflow: visible;
      /* Fixed dimensions - never change */
      min-width: var(--tableW);
      max-width: var(--tableW);
      flex-shrink: 0;
      will-change: transform;
    }

    /* Content overlay inside table - all absolutely positioned */
    .tarot-table-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    /* Enable pointer events for interactive elements */
    .tarot-table-content > * {
      pointer-events: auto;
    }

    .table-animating {
      animation: tablePulse 1.2s ease-in-out;
      box-shadow:
        0 0 120px rgba(0, 123, 255, 0.6),
        0 0 240px rgba(0, 123, 255, 0.3),
        inset 0 0 50px rgba(255, 255, 255, 0.2);
      transform-origin: center center !important;
      margin: calc(var(--pad) * 0.1) auto !important;
      /* Preserve table shape during animation - never change dimensions */
      width: var(--tableW) !important;
      aspect-ratio: var(--tableAR) !important;
      border-radius: 50% !important;
      min-width: var(--tableW) !important;
      max-width: var(--tableW) !important;
    }

    @keyframes tablePulse {
      0%, 100% {
        transform: translateZ(0) scale(1);
      }
      50% {
        transform: translateZ(0) scale(1.05);
      }
    }

    .gallery-button {
      background: rgba(0, 123, 255, 0.8);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
      min-width: 64px;
      min-height: 64px;
    }

    .gallery-button:hover {
      background: rgba(0, 123, 255, 1);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
    }

    .control-buttons {
      position: fixed !important;
      top: calc(15px + var(--safe-area-inset-top, 0)) !important;
      right: calc(15px + var(--safe-area-inset-right, 0)) !important;
      display: flex !important;
      gap: 6px !important;
      z-index: 10000 !important;
      transform: none !important;
      transform-origin: initial !important;
      animation: none !important;
      transition: none !important;
      will-change: auto !important;
      pointer-events: auto !important;
    }

    .control-buttons button {
      pointer-events: auto !important;
      z-index: 10001 !important;
    }

    /* Ensure buttons stay in place during any animations */
    .tarot-root.animating .control-buttons,
    .tarot-root.table-animating .control-buttons,
    .tarot-animating ~ .control-buttons {
      position: fixed !important;
      top: calc(20px + var(--safe-area-inset-top, 0)) !important;
      right: calc(20px + var(--safe-area-inset-right, 0)) !important;
      transform: none !important;
    }

    /* Export CSV button */
    .export-csv-btn {
      position: fixed;
      top: calc(70px + var(--safe-area-inset-top, 0));
      right: calc(20px + var(--safe-area-inset-right, 0));
      background: rgba(34, 197, 94, 0.8);
      color: #fff;
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow:
        0 4px 12px rgba(34, 197, 94, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .export-csv-btn:hover {
      background: rgba(34, 197, 94, 1);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
    }

    .tarot-deck {
      position: relative;
      width: var(--deckW);
      height: var(--deckH);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      flex-shrink: 0;
    }

    .tarot-deck:hover {
      transform: translateY(-5px) scale(1.05);
      filter: brightness(1.1);
    }

    .tarot-deck:active {
      transform: translateY(-2px) scale(1.02);
    }

    .tarot-deck-inner {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a2e 100%);
      background-image: url('./public/Assets/imagine/bc.png');
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 12px;
      box-shadow:
        0 10px 30px rgba(0, 0, 0, 0.5),
        inset 0 0 20px rgba(0, 123, 255, 0.3);
      border: 2px solid rgba(0, 123, 255, 0.5);
      position: relative;
    }
    .tarot-modal {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 0.75rem;
      text-align: center;
      max-height: 85vh;
      border: 2px solid rgba(0, 123, 255, 0.5);
      box-shadow: 0 0 40px rgba(0, 123, 255, 0.4);
      max-width: 100%;
      overflow: hidden;
    }

    /* Modals outside table (e.g., payment, reading panel) keep default positioning */
    .tarot-main > .tarot-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    /* Modals positioned absolutely relative to table oval */
    .tarot-table-content .choosing-modal,
    .tarot-table-content .custom-reading-modal {
      position: absolute !important;
      left: 50% !important;
      top: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: clamp(280px, min(480px, calc(var(--tableW) * 0.85)), 90vw) !important;
      max-width: calc(var(--tableW) * 0.9) !important;
      z-index: 100 !important;
      pointer-events: auto !important;
      margin: 0 !important;
      /* Ensure modal stays within oval bounds */
      box-sizing: border-box;
    }

    .choosing-modal {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.05),
        rgba(0, 50, 150, 0.05),
        rgba(0, 123, 255, 0.03)
      );
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: none;
      border-radius: 20px;
      padding: 2rem;
    }

    .custom-reading-modal {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.15),
        rgba(0, 50, 150, 0.15),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow:
        0 8px 32px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      padding: 2rem;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 1.5rem;
    }

    .modal-bottom-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
    }

    .modal-back-btn {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.2),
        rgba(0, 50, 150, 0.2),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      padding: 8px 11px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow:
        0 8px 32px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      min-width: 32px;
    }

    .modal-back-btn:hover {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.3),
        rgba(0, 50, 150, 0.3),
        rgba(0, 123, 255, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transform: scale(1.1);
      box-shadow:
        0 12px 40px rgba(0, 123, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .sound-toggle-btn {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.2),
        rgba(0, 50, 150, 0.2),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow:
        0 2px 12px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      margin-right: 8px;
      min-width: 64px;
      min-height: 64px;
    }

    /* Sound toggle button positioned under wallet button */
    .sound-toggle-btn-left {
      position: fixed !important;
      top: calc(20px + 64px + 8px + var(--safe-area-inset-top, 0)) !important;
      left: calc(20px + var(--safe-area-inset-left, 0)) !important;
      margin-right: 0 !important;
      z-index: 10000 !important;
    }

    .sound-toggle-btn:hover {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.3),
        rgba(0, 50, 150, 0.3),
        rgba(0, 123, 255, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transform: scale(1.1);
      box-shadow:
        0 12px 40px rgba(0, 123, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Wallet connect button */
    .wallet-connect-btn {
      position: fixed;
      top: calc(20px + var(--safe-area-inset-top, 0));
      left: calc(20px + var(--safe-area-inset-left, 0));
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.2),
        rgba(0, 50, 150, 0.2),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 24px;
      color: #fff;
      padding: 16px 24px;
      font-size: 24px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow:
        0 8px 32px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1),
        inset 0 0 80px rgba(0, 123, 255, 0.1);
      min-width: 160px;
      min-height: 64px;
      text-align: center;
      z-index: 10000;
      pointer-events: auto;
    }

    .wallet-connect-btn:hover {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.3),
        rgba(0, 50, 150, 0.3),
        rgba(0, 123, 255, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transform: scale(1.05);
      box-shadow:
        0 12px 40px rgba(0, 123, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .wallet-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .wallet-connect-btn .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
      font-size: 24px;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .wallet-connect-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .modal-header h2 {
      margin: 0;
      flex: 1;
      text-align: center;
    }

    /* Symmetric custom modal content */
    .custom-modal-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      max-width: 500px;
      width: 100%;
      box-sizing: border-box;
    }

    .custom-modal-title {
      width: 100%;
      text-align: center;
      margin: 0;
    }

    .custom-modal-hint {
      width: 100%;
      text-align: center;
      margin: 0;
      opacity: 0.8;
    }

    .custom-modal-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(0, 123, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
    }

    .custom-modal-input:focus {
      outline: none;
      border-color: rgba(0, 123, 255, 0.6);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
    }

    .custom-modal-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .custom-modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: 100%;
    }

    .custom-modal-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 48px;
      box-sizing: border-box;
    }

    .custom-modal-btn.primary {
      background: rgba(0, 123, 255, 0.8);
      color: #fff;
    }

    .custom-modal-btn.primary:hover:not(:disabled) {
      background: rgba(0, 123, 255, 1);
    }

    .custom-modal-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(0, 123, 255, 0.3);
    }

    .custom-modal-btn.secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
    }

    .custom-modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Gallery modal */
    .gallery-modal {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 1rem;
      width: 95vw;
      max-height: 85vh;
      max-width: 1200px;
      max-height: 90vh;
      overflow: hidden;
      border: 2px solid rgba(0, 123, 255, 0.5);
      box-shadow: 0 0 50px rgba(0, 123, 255, 0.4);
      display: flex;
      flex-direction: column;
      z-index: 1500;
    }

    .gallery-modal h2 {
      color: #fff;
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2.5rem;
      text-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
      flex-shrink: 0;
    }

    .gallery-content {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .gallery-section h3 {
      color: #fff;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
      border-bottom: 1px solid rgba(0, 123, 255, 0.3);
      padding-bottom: 0.5rem;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .gallery-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 123, 255, 0.2);
    }

    .gallery-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
      border-color: rgba(0, 123, 255, 0.5);
    }

    .gallery-card img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      display: block;
    }

    .gallery-card-info {
      padding: 10px;
      text-align: center;
    }

    .gallery-card-name {
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .gallery-card-keyword {
      color: rgba(0, 123, 255, 0.8);
      font-size: 12px;
      font-style: italic;
      line-height: 1.2;
    }

    .gallery-close-btn {
      display: block;
      margin: 2rem auto 0;
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.2),
        rgba(0, 50, 150, 0.2),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow:
        0 8px 32px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .gallery-close-btn:hover {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.3),
        rgba(0, 50, 150, 0.3),
        rgba(0, 123, 255, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transform: translateY(-2px);
      box-shadow:
        0 12px 40px rgba(0, 123, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Clean responsive system - Mobile-first */

    /* Base mobile styles (applied to all screens) */
    .tarot-main {
      min-height: unset;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      /* Container allows scrolling on very small screens */
      .tarot-container {
        overflow-y: auto;
        min-height: calc(var(--vh, 1vh) * 100);
      }

      /* Modals fit viewport with safe scroll */
      .tarot-reading-overlay,
      .tarot-modal,
      .gallery-modal {
        padding: var(--pad);
      }

      .tarot-reading-panel,
      .tarot-modal,
      .gallery-modal {
        max-height: calc(100svh - (var(--pad) * 2) - var(--safe-area-inset-top, 0) - var(--safe-area-inset-bottom, 0));
        overflow-y: auto;
        width: min(92vw, 600px);
        margin: 0 auto;
      }

      /* Custom modal adjustments */
        .custom-modal-content {
        gap: var(--pad);
          max-width: 100%;
        }

        .custom-modal-input {
          font-size: 16px; /* Prevent zoom on iOS */
        }

        .custom-modal-actions {
        gap: calc(var(--pad) / 2);
        }

        .custom-modal-btn {
          min-height: 44px;
          font-size: 14px;
        }
    }

    /* Tablet and desktop adjustments */
    @media (min-width: 769px) {
      .tarot-main {
        min-height: 400px;
      }

      .tarot-reading-panel,
      .tarot-modal,
      .gallery-modal {
        max-height: 80vh;
        width: auto;
        margin: 0;
        }
    }

    .tarot-modal h2 {
      color: #fff;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }

    .tarot-option {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 1rem auto;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.15),
        rgba(0, 50, 150, 0.15),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow:
        0 8px 32px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
    }

    .tarot-option:hover:not(:disabled) {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.25),
        rgba(0, 50, 150, 0.25),
        rgba(0, 123, 255, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transform: translateY(-2px);
      box-shadow:
        0 12px 40px rgba(0, 123, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .tarot-option:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .custom-reading-overlay-button {
      position: relative;
      width: 100px;
      height: 33px;
      border: none;
      background: transparent;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      padding: 0;
      margin: 0;
      display: inline-block;
      overflow: hidden;
      box-sizing: border-box;
    }

    .custom-reading-overlay-button:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
    }

    .custom-reading-overlay-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .custom-reading-underlay-image {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
      margin: 0;
      padding: 0;
    }

    /* Custom reading modal */
    .tarot-custom-modal {
      max-width: 500px;
      width: 90%;
    }

    /* Spread selection layout */
    .spread-selection {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 1rem clamp(1.5rem, 4vw, 3rem);
      margin: calc(var(--pad) * 0.5) 0;
      justify-items: center;
      align-items: center;
      max-width: 100%;
    }

    /* Mobile: keep 2 columns for spread options */
    @media (max-width: 768px) {
      .spread-selection {
        gap: calc(var(--pad) * 0.5);
        margin: calc(var(--pad) * 0.25) 0;
      }

      .spread-option {
        width: 100%;
        max-width: 160px; /* Smaller for mobile */
      }

      .preview-card {
        width: clamp(72px, 18vw, 120px);
        height: calc(clamp(72px, 18vw, 120px) * 1.46);
      }
    }

    .spread-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: opacity 0.3s ease;
      cursor: pointer;
      transform: scale(0.75);
    }

    .single-card-option {
      grid-column: 1;
      grid-row: 1;
      transform: translateX(20px);
    }

    .three-cards-option {
      grid-column: 2;
      grid-row: 1;
      transform: translateX(-20px);
    }

    .custom-reading-button {
      grid-column: 1 / -1;
      grid-row: 2;
      justify-self: center;
    }

    .spread-preview {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 1rem;
      position: relative;
    }

    .preview-card {
      width: var(--cardW);
      height: var(--cardH);
      position: relative;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .preview-card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
    }

    .preview-card-back,
    .preview-card-front {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 8px;
    }

    .preview-card-back {
      background-image: url('./public/Assets/imagine/bc.png');
      background-size: 140% 140%;
      background-position: center;
      background-repeat: no-repeat;
      border: 1px solid rgba(138, 43, 226, 0.3);
    }

    .preview-card-front {
      background: rgba(245, 245, 220, 0.9);
      transform: rotateY(180deg);
      border: 1px solid rgba(138, 43, 226, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .preview-card-image {
      width: 100%;
      height: 100%;
      object-fit: fill;
      border-radius: 6px;
    }

    /* Three cards layout - fan effect */
    .three-preview-card {
      position: absolute;
    }

    .left-card {
      transform: rotate(-15deg) translateX(-30px);
      z-index: 1;
    }

    .center-card {
      z-index: 2;
    }

    .right-card {
      transform: rotate(15deg) translateX(30px);
      z-index: 1;
    }
    .custom-reading-button {
      margin-top: 1rem;
      width: 100%;
    }

    .tarot-custom-hint {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-style: italic;
    }

    .tarot-custom-note {
      color: rgba(255, 215, 0, 0.8);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .tarot-question-input {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(0, 123, 255, 0.5);
      border-radius: 12px;
      color: #fff;
      resize: vertical;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
    }

    .tarot-question-input:focus {
      outline: none;
      border-color: rgba(0, 123, 255, 0.8);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
    }

    .tarot-question-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .tarot-custom-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .tarot-custom-buttons .tarot-button {
      flex: 1;
      max-width: 150px;
    }

    /* AI Interpretation panel */
    .tarot-ai-panel {
      max-width: 700px;
    }

    .tarot-reading-question {
      font-size: 1.1rem;
      color: rgba(255, 215, 0, 0.9);
      font-style: italic;
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(0, 123, 255, 0.1);
      border-radius: 8px;
      border-left: 3px solid rgba(255, 215, 0, 0.6);
    }

    .tarot-ai-interpretation {
      line-height: 1.8;
      font-size: 1rem;
      margin: 1.5rem 0;
    }

    .tarot-ai-interpretation strong {
      color: #ffd700;
      font-weight: 600;
    }

    .tarot-ai-interpretation p {
      margin-bottom: 1.5rem;
    }

    .tarot-ai-loading {
      text-align: center;
      padding: 2rem;
    }

    .tarot-ai-loading .tarot-sparkles {
      font-size: 3rem;
      animation: sparkle 1s ease-in-out infinite;
      margin-bottom: 1rem;
    }
    .tarot-generating {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-style: italic;
    }

    @keyframes sparkle {
      0%, 100% {
        transform: scale(1) rotate(0deg);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 1;
      }
    }
    /* Animation before spread - dealer effect */
    .tarot-animating {
      text-align: center;
      color: #fff;
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    @keyframes fadeInOut {
      0%, 100% {
        opacity: 0.5;
      }
      50% {
        opacity: 1;
      }
    }

    /* Card spread layout */
    .tarot-spread {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--pad);
      flex-wrap: wrap;
      width: 100%;
      perspective: 1000px;
      transform: none;
    }

    /* Card slot - handles ONLY position (translate/left/top) */
    .card-slot {
      position: relative;
      width: var(--card-w);
      height: var(--card-h);
      flex-shrink: 0;
      /* Ensure slot is visible */
      display: block;
    }

    /* Position slots for three-card spread */
    .tarot-spread {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--pad);
      flex-wrap: wrap;
      width: 100%;
      perspective: 1000px;
      transform: none;
    }

    /* Single card - centered via flexbox */
    /* Three cards - positioned via flexbox gap in .tarot-spread */

    /* Card animation layer - handles ONLY rotate/scale/flip/animation */
    .card-anim {
      width: 100%;
      height: 100%;
      cursor: pointer;
      position: relative;
      transform-style: preserve-3d;
      will-change: transform;
      opacity: 1;
      /* Ensure visibility */
      display: block;
      min-height: 1px;
    }
    
    /* Set opacity to 0 for animation start */
    .card-slot.card-single .card-anim,
    .card-slot.card-left .card-anim,
    .card-slot.card-center .card-anim,
    .card-slot.card-right .card-anim {
      opacity: 0;
    }
    

    /* Legacy class support - map to card-anim */
    .tarot-card {
      width: var(--card-w);
      height: var(--card-h);
      cursor: pointer;
      position: relative;
      transition: transform 0.3s ease;
      opacity: 0;
      flex-shrink: 0;
      transform-style: preserve-3d;
    }

    /* Animation for single card - dealer throws from top to center */
    .card-slot.card-single .card-anim {
      animation: dealerThrowFromTopCenter 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s forwards;
    }

    @keyframes dealerThrowFromTopCenter {
      0% {
        opacity: 0;
        transform: translateZ(0) rotate(-180deg) scale(0.8);
      }
      60% {
        opacity: 1;
        transform: translateZ(0) rotate(5deg) scale(1.05);
      }
      80% {
        transform: translateZ(0) rotate(-2deg) scale(1.02);
      }
      100% {
        opacity: 1;
        transform: translateZ(0) translate3d(0, 0, 0) rotate(0deg) scale(1);
      }
    }

    /* Animation for three cards - dealer throws from top, sequence left to right */
    .card-slot.card-left .card-anim {
      animation: dealerThrowFromTopLeft 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s forwards;
    }

    .card-slot.card-center .card-anim {
      animation: dealerThrowFromTopCenterCard 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.4s forwards;
    }

    .card-slot.card-right .card-anim {
      animation: dealerThrowFromTopRight 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.6s forwards;
    }

    @keyframes dealerThrowFromTopLeft {
      0% {
        opacity: 0;
        transform: translateZ(0) rotate(-180deg) scale(0.8);
      }
      60% {
        opacity: 1;
        transform: translateZ(0) rotate(-12deg) scale(1.05);
      }
      80% {
        transform: translateZ(0) rotate(-16deg) scale(1.02);
      }
      100% {
        opacity: 1;
        transform: translateZ(0) translate3d(0, 0, 0) rotate(-15deg) scale(1);
      }
    }

    @keyframes dealerThrowFromTopCenterCard {
      0% {
        opacity: 0;
        transform: translateZ(0) rotate(-180deg) scale(0.8);
      }
      60% {
        opacity: 1;
        transform: translateZ(0) rotate(5deg) scale(1.05);
      }
      80% {
        transform: translateZ(0) rotate(-2deg) scale(1.02);
      }
      100% {
        opacity: 1;
        transform: translateZ(0) translate3d(0, 0, 0) rotate(0deg) scale(1);
      }
    }

    @keyframes dealerThrowFromTopRight {
      0% {
        opacity: 0;
        transform: translateZ(0) rotate(-180deg) scale(0.8);
      }
      60% {
        opacity: 1;
        transform: translateZ(0) rotate(12deg) scale(1.05);
      }
      80% {
        transform: translateZ(0) rotate(14deg) scale(1.02);
      }
      100% {
        opacity: 1;
        transform: translateZ(0) translate3d(0, 0, 0) rotate(15deg) scale(1);
      }
    }

    /* Hover effects on card-anim */
    .card-anim:hover {
      transform: translateZ(0) translateY(-10px) scale(1);
    }

    .card-slot.card-left .card-anim:hover {
      transform: translateZ(0) translateY(-10px) rotate(-15deg) scale(1);
    }

    .card-slot.card-right .card-anim:hover {
      transform: translateZ(0) translateY(-10px) rotate(15deg) scale(1);
    }

    /* Legacy hover support */
    .tarot-card:hover {
      transform: translateY(-10px);
    }

    .tarot-card.card-left:hover {
      transform: rotate(-15deg) translateY(-10px);
    }

    .tarot-card.card-right:hover {
      transform: rotate(15deg) translateY(-10px);
    }

    .tarot-card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
    }

    .card-anim.card-revealed .tarot-card-inner {
      transform: rotateY(180deg);
    }

    /* Legacy support */
    .tarot-card.card-revealed .tarot-card-inner {
      transform: rotateY(180deg);
    }

    .tarot-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      background-image: url('./public/Assets/imagine/bc.png');
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;
      background-origin: border-box;
      background-clip: border-box;
      border: 2px solid rgba(0, 123, 255, 0.5);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .tarot-card-front {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 123, 255, 0.3);
      transform: rotateY(180deg);
      padding: 0;
      margin: 0;
      display: block;
      overflow: hidden;
      position: relative;
    }

    .tarot-card-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: inherit;
    }

    .tarot-card-fallback {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      text-align: center;
    }
    .tarot-card-name {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #007bff;
    }

    .tarot-card-keyword {
      font-size: 0.9rem;
      font-style: italic;
      color: #4a5568;
      margin-bottom: 0.5rem;
    }
    .tarot-footer {
      position: absolute;
      bottom: calc(var(--pad) * 0.3);
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      z-index: 20;
      width: auto;
      max-width: calc(var(--tableW) - var(--pad) * 2);
      pointer-events: auto;
    }

    .tarot-button {
      padding: 2rem 5rem;
      font-size: 2.4rem;
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.2),
        rgba(0, 50, 150, 0.2),
        rgba(0, 123, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow:
        0 8px 32px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
    }

    .tarot-button:hover {
      background: linear-gradient(135deg,
        rgba(0, 123, 255, 0.3),
        rgba(0, 50, 150, 0.3),
        rgba(0, 123, 255, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transform: translateY(-2px);
      box-shadow:
        0 12px 40px rgba(0, 123, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .tarot-button.secondary {
      background: linear-gradient(135deg,
        rgba(0, 50, 150, 0.2),
        rgba(0, 123, 255, 0.2),
        rgba(0, 50, 150, 0.1)
      );
    }

    .tarot-button.secondary:hover {
      background: linear-gradient(135deg,
        rgba(0, 50, 150, 0.3),
        rgba(0, 123, 255, 0.3),
        rgba(0, 50, 150, 0.2)
      );
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .tarot-reading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .tarot-reading-panel {
      background: linear-gradient(135deg, rgba(26, 10, 46, 0.95), rgba(22, 33, 62, 0.95));
      border: 2px solid rgba(0, 123, 255, 0.6);
      border-radius: 20px;
      padding: 2.5rem;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      color: #fff;
      box-shadow: 0 0 60px rgba(0, 123, 255, 0.5);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .tarot-reading-panel h2 {
      font-size: 1.8rem;
      margin: 0 0 0.5rem 0;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tarot-reading-position {
      font-size: 0.9rem;
      color: rgba(0, 123, 255, 0.9);
      font-weight: 600;
      margin: 0.25rem 0;
      padding: 0.25rem;
      background: rgba(0, 123, 255, 0.1);
      border-radius: 8px;
      border-left: 3px solid rgba(0, 123, 255, 0.6);
    }

    .tarot-reading-card-image {
      text-align: center;
      margin: 1rem 0;
      transform: none;
    }

    .tarot-reading-card-image img {
      width: 100%;
      max-width: 240px;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      border: 2px solid rgba(0, 123, 255, 0.6);
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
      display: block;
      margin: 0 auto;
      transform: none;
      scale: 1;
    }

    .tarot-reading-keyword {
      font-size: 1rem;
      font-style: italic;
      color: #ffd700;
      margin: 0.5rem 0;
    }

    .tarot-reading-text {
      font-size: 0.9rem;
      line-height: 1.5;
      color: rgba(255, 255, 255, 0.9);
      margin: 0.75rem 0;
    }

    .tarot-reading-panel .tarot-button {
      margin-top: 1.5rem;
      width: 100%;
    }

    @media (max-width: 768px) {
      .tarot-container {
        padding: calc(var(--pad) + 60px + var(--safe-area-inset-top, 0)) var(--pad) var(--pad) var(--pad);
        min-height: calc(var(--vh, 1vh) * 100);
        height: auto;
      }

      .tarot-header {
        margin-bottom: 0.5rem;
      }

      .tarot-header h1 {
        font-size: 1.2rem;
        margin: 0;
        position: fixed !important;
        top: calc(8px + var(--safe-area-inset-top, 0)) !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        display: block !important;
        text-align: center !important;
        z-index: 1001 !important;
      }

      .tarot-header p {
        font-size: 0.7rem;
        margin-top: 0.1rem;
      }

      .payment-info {
        gap: 0.5rem;
        margin-top: 0.25rem;
      }

      .payment-item {
        font-size: 0.8rem;
      }

      .tx-status {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      .tarot-main {
        justify-content: center !important;
      }

      .tarot-table-wrap {
        transform: translateY(-8vh) !important;
      }

      .tarot-table {
        min-height: 150px;
        padding: 0.25rem;
        margin: calc(var(--pad) * 0.1) 0 !important;
      }

      .card-slot {
        width: var(--card-w);
        height: var(--card-h);
      }

      /* Legacy support */
      .tarot-card {
        width: var(--cardW);
        height: var(--cardH);
      }

      .tarot-spread {
        gap: 0.5rem;
      }

      /* Rotation handled by animation, not by static transform */
      /* Remove static transforms - they're in animations now */

      /* Mobile spread selection - stack vertically */


      .three-preview-card.left-card {
        transform: rotate(-8deg) translateX(-8px);
      }

      .three-preview-card.right-card {
        transform: rotate(8deg) translateX(8px);
      }


      /* Mobile: all options stack in single column */
      /* Keep spread options in grid, custom button stays in modal-bottom-buttons */

      .tarot-footer {
        position: absolute !important;
        bottom: calc(var(--pad) * 0.2 + var(--safe-area-inset-bottom, 0) * 0.3) !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        gap: 1rem;
        width: auto !important;
        max-width: calc(var(--tableW) - var(--pad) * 2) !important;
      }

      .tarot-button {
        padding: 1.5rem 3rem;
        font-size: 2rem;
      }

      .tarot-reading-panel {
        padding: 1rem;
        max-height: 85vh;
      }

      .tarot-reading-overlay {
        transform: none !important;
        scale: 1 !important;
      }

      .tarot-reading-panel {
        transform: none !important;
        scale: 1 !important;
      }

      .tarot-reading-panel * {
        transform: none !important;
        scale: 1 !important;
      }

      .tarot-reading-panel h2 {
        font-size: 1.2rem;
        margin: 0 0 0.25rem 0;
      }

      .tarot-reading-card-image {
        transform: none !important;
        scale: 1 !important;
        width: auto !important;
        height: auto !important;
        display: block !important;
        position: relative !important;
      }

      .tarot-reading-card-image * {
        transform: none !important;
        scale: 1 !important;
      }

      .tarot-reading-card-image img {
        width: 80px !important;
        max-width: 80px !important;
        min-width: 80px !important;
        height: auto !important;
        transform: none !important;
        scale: 1 !important;
        zoom: 1 !important;
        object-fit: contain !important;
        display: block !important;
        margin: 0 auto !important;
        box-sizing: border-box !important;
        position: relative !important;
      }

      .tarot-reading-keyword {
        font-size: 0.8rem;
        margin: 0.25rem 0;
      }

      .tarot-reading-text {
        font-size: 0.8rem;
        margin: 0.5rem 0;
        line-height: 1.4;
      }

      .tarot-modal {
        padding: 0.5rem;
      }

      .choosing-modal {
        padding: 1.5rem;
      }

      .custom-reading-modal {
        padding: 1.5rem;
      }

      .modal-header h2 {
        font-size: 1.5rem;
      }

      .modal-bottom-buttons {
        gap: 12px;
        margin-top: 12px;
      }

      .modal-back-btn {
        padding: 7px 9px;
        font-size: 9px;
        min-width: 29px;
      }

      .tarot-option {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        margin: 0.5rem auto;
      }

      .sound-toggle-btn-left {
        top: calc(15px + 80px + 8px + var(--safe-area-inset-top, 0)) !important;
        left: calc(15px + var(--safe-area-inset-left, 0)) !important;
        padding: 16px 20px !important;
        font-size: 32px !important;
        min-width: 80px !important;
        min-height: 80px !important;
      }

      .wallet-connect-btn {
        top: calc(15px + var(--safe-area-inset-top, 0));
        left: calc(15px + var(--safe-area-inset-left, 0));
        padding: 12px 16px;
        font-size: 20px;
        min-width: 140px;
        min-height: 80px;
      }

      .wallet-avatar {
        width: 40px;
        height: 40px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .custom-reading-overlay-button {
        width: 80px;
        height: 50px;
        margin: 0;
      }

      /* Additional mobile optimizations for very small screens */
      @media (max-width: 480px) {
        :root {
          --card-w: clamp(92px, 26vw, 132px);
          --cardW: var(--card-w);
        }

        .control-buttons {
          top: calc(8px + var(--safe-area-inset-top, 0)) !important;
          right: calc(8px + var(--safe-area-inset-right, 0)) !important;
          gap: 4px !important;
        }

        .sound-toggle-btn-left {
          top: calc(10px + 56px + 8px + var(--safe-area-inset-top, 0)) !important;
          left: calc(10px + var(--safe-area-inset-left, 0)) !important;
          padding: 8px 12px !important;
          font-size: 24px !important;
          min-width: 56px !important;
          min-height: 56px !important;
        }

        .gallery-button {
          padding: 8px 12px !important;
          font-size: 24px !important;
          min-width: 56px !important;
          min-height: 56px !important;
        }

        .wallet-connect-btn {
          top: calc(10px + var(--safe-area-inset-top, 0)) !important;
          left: calc(10px + var(--safe-area-inset-left, 0)) !important;
          padding: 8px 12px !important;
          font-size: 20px !important;
          min-width: 100px !important;
          min-height: 56px !important;
        }

        .tarot-header h1 {
          font-size: 1.8rem !important;
          top: calc(10px + var(--safe-area-inset-top, 0)) !important;
          left: 0 !important;
          right: 0 !important;
          width: 100% !important;
          display: block !important;
          text-align: center !important;
        }

        .tarot-container {
          padding-top: calc(var(--pad) + 45px + var(--safe-area-inset-top, 0)) !important;
        }

        .card-slot {
          width: var(--card-w) !important;
          height: var(--card-h) !important;
        }

        /* Legacy support */
        .tarot-card {
          width: var(--card-w) !important;
          height: var(--card-h) !important;
        }

        .tarot-table {
          padding: 0.15rem !important;
          min-height: 120px !important;
        }

        .tarot-main {
          min-height: 300px !important;
          justify-content: center !important;
        }

        .tarot-table-wrap {
          transform: translateY(-6vh) !important;
        }

        .tarot-table {
          margin: calc(var(--pad) * 0.05) 0 !important;
        }

        .wallet-avatar {
          width: 18px !important;
          height: 18px !important;
          border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
      }

      /* Landscape orientation optimizations */
      @media (max-height: 500px) and (orientation: landscape) {
        .control-buttons {
          top: calc(5px + var(--safe-area-inset-top, 0)) !important;
        }

        .wallet-connect-btn {
          top: calc(8px + var(--safe-area-inset-top, 0)) !important;
          left: calc(8px + var(--safe-area-inset-left, 0)) !important;
        }

        .tarot-header h1 {
          font-size: 1.6rem !important;
          top: calc(8px + var(--safe-area-inset-top, 0)) !important;
          left: 0 !important;
          right: 0 !important;
          width: 100% !important;
          display: block !important;
          text-align: center !important;
        }

        .tarot-container {
          padding-top: calc(var(--pad) + 35px + var(--safe-area-inset-top, 0)) !important;
        }

        .tarot-main {
          justify-content: center !important;
        }

        .tarot-table-wrap {
          transform: translateY(-5vh) !important;
        }

        .tarot-table {
          min-height: 100px !important;
        }
      }

    }

    /* Debug mode: add data-debug="1" to body */
    /* DEBUG MODE - Show all containers with red outlines to find layout cutters */
    [data-debug="1"] * {
      outline: 1px solid rgba(255, 0, 0, 0.3) !important;
    }

    [data-debug="1"] .tarot-root {
      outline: 2px solid red !important;
    }

    [data-debug="1"] .tarot-container {
      outline: 2px solid orange !important;
    }

    [data-debug="1"] .tarot-modal,
    [data-debug="1"] .tarot-reading-overlay {
      outline: 3px solid purple !important;
      background: rgba(128, 0, 128, 0.1) !important;
    }

    [data-debug="1"] .tarot-table {
      outline: 2px solid blue !important;
    }

    [data-debug="1"] .tarot-card {
      outline: 1px solid green !important;
    }

    [data-debug="1"] .single-card-option,
    [data-debug="1"] .three-cards-option {
      outline: 2px solid yellow !important;
      background: rgba(255, 255, 0, 0.1) !important;
    }

    [data-debug="1"] .tarot-button {
      outline: 1px solid cyan !important;
    }

    [data-debug="1"]::after {
      content: "Viewport: " attr(data-viewport) " | DEBUG MODE";
      position: fixed; top: 10px; right: 10px;
      background: rgba(255, 0, 0, 0.9); color: white;
      padding: 5px 10px; border-radius: 4px; font-size: 12px;
      z-index: 9999;
      border: 2px solid white;
    }

    /* TopBar Styles */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 2000;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: calc(12px + env(safe-area-inset-top)) 14px 12px 14px;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
    }

    .topbar-title{
      grid-column: 2;
      justify-self: center;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .topbar-actions {
      grid-column: 3;
      justify-self: end;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .icon-btn{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(20,40,80,0.35);
      color: #fff;
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .icon-btn:active{
      transform: scale(0.98);
    }

    .avatar-btn {
      padding: 0;
      overflow: hidden;
    }

    .avatar-img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .avatar-fallback{
      font-size: 18px;
      }

      .tarot-footer {
        position: absolute !important;
        bottom: calc(var(--pad) * 0.15 + var(--safe-area-inset-bottom, 0) * 0.5) !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        gap: 0.75rem;
        width: auto !important;
        max-width: calc(var(--tableW) - var(--pad) * 2) !important;
      }

      .tarot-button {
        padding: 0.4rem 1rem;
        font-size: 1.4rem;
      }

      /* Mobile gallery adaptations */
      .gallery-modal {
        padding: 0.8rem;
        width: 95vw;
        max-width: none;
        max-height: 80vh;
      }

      .gallery-modal h2 {
        font-size: 2rem;
        margin-bottom: 1.5rem;
      }

      .gallery-content {
        gap: 1.5rem;
      }

      .gallery-grid {
        gap: 0.5rem;
      }

      .gallery-grid {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 0.5rem;
      }

      .gallery-card img {
        height: 80px;
      }

      .gallery-card-name {
        font-size: 12px;
      }

      .gallery-card-keyword {
        font-size: 10px;
      }

      .gallery-section h3 {
        font-size: 1.25rem;
      }

    /* Mobile-specific fixes */
    .sound-toggle-btn,
    .wallet-connect-btn,
    .gallery-button,
    .export-csv-btn {
      padding: clamp(6px, 1.6vw, 10px) !important;
      font-size: clamp(20px, 5vw, 24px) !important;
      min-width: 60px !important;
      min-height: 60px !important;
    }

    /* Mobile modals */
    .tarot-modal {
      max-height: calc(100dvh - var(--pad) - var(--safe-area-inset-top, 0) - var(--safe-area-inset-bottom, 0));
      overflow-y: auto;
      overflow-x: hidden;
    }

    .tarot-reading-overlay {
      padding: calc(var(--space) + var(--safe-area-inset-top, 0)) var(--space) calc(var(--space) + var(--safe-area-inset-bottom, 0)) !important;
    }

    .tarot-reading-panel {
      padding: clamp(4px, 1vw, 12px) !important;
      max-height: calc(100dvh - (var(--space) * 2) - var(--safe-area-inset-top, 0) - var(--safe-area-inset-bottom, 0)) !important;
      width: min(92vw, 600px) !important;
      margin: 0 !important;
    }

    .gallery-modal,
    .tarot-custom-modal {
      max-height: calc(100dvh - (var(--space) * 2) - var(--safe-area-inset-top, 0) - var(--safe-area-inset-bottom, 0)) !important;
      margin: 0 !important;
      overflow-y: auto !important;
    }

    /* Prevent horizontal scroll on mobile */
    body {
      overflow-x: hidden !important;
    }

    /* Mobile-specific background attachment fix */
    .tarot-background {
      background-attachment: scroll !important;
    }

    /* Allow vertical scroll on very small screens */
    .tarot-main {
      min-height: unset !important;
    }

    /* CRITICAL FIX: Choosing modal visibility on mobile */
    /* 1. Disable content clipping for choosing modal */
    .choosing-modal {
      overflow: visible !important;
    }

    /* 2. Fix spread-selection grid to always show 2 columns in choosing modal */
    .choosing-modal .spread-selection {
      display: grid !important;
      grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      gap: clamp(12px, 4vw, 24px) !important;
      margin: var(--pad) 0 !important;
      justify-items: center !important;
      align-items: center !important;
    }

    /* 3. Remove translateX transforms that cause overflow on mobile */
    @media (max-width: 768px) {
      .choosing-modal .single-card-option,
      .choosing-modal .three-cards-option {
        transform: none !important;
      }
    }

    /* 4. Ensure spread-preview has minimum height to prevent collapse */
    .choosing-modal .spread-preview {
      min-height: calc(var(--cardH) + 14px) !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      margin-bottom: 1rem !important;
    }

    /* 5. Force choosing modal to be visible and not clipped */
    .choosing-modal .spread-option {
      opacity: 1 !important;
      visibility: visible !important;
      display: block !important;
    }

    /* ===========================================
       CHOOSING MENU REDESIGN OVERRIDE
       =========================================== */

    /* Main choosing modal panel - compact glass design */
    .tarot-table-content .tarot-modal.choosing-modal {
      position: absolute !important;
      left: 50% !important;
      top: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: clamp(280px, min(480px, calc(var(--tableW) * 0.85)), 90vw) !important;
      max-width: calc(var(--tableW) * 0.9) !important;
      aspect-ratio: 1 / 0.7 !important;
      background: rgba(10, 18, 48, 0.1) !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      border: 1px solid rgba(255, 255, 255, 0.08) !important;
      border-radius: 16px !important;
      box-shadow: none !important;
      padding: 0 !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: space-between !important;
      align-items: center !important;
      margin: 0 !important;
      z-index: 100 !important;
      overflow: visible !important;
    }

    /* Spread selection - force 2 columns layout */
    .choosing-modal .spread-selection {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr) !important;
      grid-template-rows: auto !important;
      gap: clamp(16px, 5vw, 32px) !important;
      width: 100% !important;
      padding: clamp(20px, 6vw, 32px) clamp(16px, 4vw, 24px) 0 !important;
      margin: 0 !important;
      justify-items: center !important;
      align-items: center !important;
    }

    /* Remove transforms that offset options */
    .choosing-modal .single-card-option,
    .choosing-modal .three-cards-option {
      grid-column: auto !important;
      grid-row: auto !important;
      transform: none !important;
      width: 100% !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
    }

    /* Ensure all preview cards are the same size */
    /* Preview cards - same size as deck card */
    .choosing-modal .preview-card,
    .choosing-modal .single-preview-card,
    .choosing-modal .three-preview-card,
    .choosing-modal .preview-card-inner {
      width: var(--deckW) !important;
      height: var(--deckH) !important;
      border-radius: 8px !important;
    }

    .choosing-modal .preview-card {
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow:
        0 4px 16px rgba(0, 123, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    }

    /* Three-card fan - smaller rotations */
    .choosing-modal .three-preview-card.left-card {
      transform: rotate(-10deg) translateX(-18px) !important;
    }

    .choosing-modal .three-preview-card.right-card {
      transform: rotate(10deg) translateX(18px) !important;
    }

    .choosing-modal .three-preview-card.center-card {
      z-index: 2 !important;
    }

    /* Spread preview container */
    .choosing-modal .spread-preview {
      min-height: calc(var(--deckH) + 8px) !important;
      width: 100% !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      position: relative !important;
    }

    /* Bottom buttons area - centered row */
    .choosing-modal .modal-bottom-buttons {
      display: flex !important;
      flex-direction: row !important;
      justify-content: center !important;
      align-items: center !important;
      gap: clamp(12px, 4vw, 20px) !important;
      width: 100% !important;
      padding: clamp(16px, 4vw, 24px) clamp(16px, 4vw, 24px) clamp(20px, 6vw, 32px) !important;
      margin: 0 !important;
    }

    /* Back button - hidden in choosing modal */
    .choosing-modal .modal-back-btn {
      display: none !important;
    }

    .choosing-modal .modal-back-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 123, 255, 1), rgba(0, 50, 150, 1)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4) !important;
    }

    /* Custom Reading button - larger PNG button */
    .choosing-modal .custom-reading-overlay-button {
      width: 170px !important;
      height: 53px !important;
      padding: 0 !important;
      border-radius: 8px !important;
      overflow: hidden !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3) !important;
      transition: all 0.2s ease !important;
    }

    .choosing-modal .custom-reading-overlay-button img {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      display: block !important;
    }

    .choosing-modal .custom-reading-overlay-button:hover:not(:disabled) {
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4) !important;
    }

    /* Mobile adjustments - keep 2 columns but smaller */
    @media (max-width: 768px) {
      .tarot-table-content .tarot-modal.choosing-modal {
        position: absolute !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: clamp(280px, min(460px, calc(var(--tableW) * 0.85)), 95vw) !important;
        max-width: calc(var(--tableW) * 0.9) !important;
        aspect-ratio: 1 / 0.75 !important;
        max-height: calc(var(--tableW) * var(--tableAR) * 0.9) !important;
        overflow-y: auto !important;
        margin: 0 !important;
      }

      .choosing-modal .preview-card,
      .choosing-modal .single-preview-card,
      .choosing-modal .three-preview-card,
      .choosing-modal .preview-card-inner {
        width: var(--deckW) !important;
        height: var(--deckH) !important;
      }

      .choosing-modal .spread-preview {
        min-height: calc(var(--deckH) + 8px) !important;
        width: 100% !important;
      }

      .choosing-modal .custom-reading-overlay-button {
        width: 140px !important;
        height: 44px !important;
      }

      .choosing-modal .modal-back-btn {
        display: none !important;
      }
    }
  </style>
</body>
</html>
</html>